---
title: "Author Attributes Test"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    toc: false
geometry: margin=0.5in
header-includes:
  - \usepackage{float}
  - \usepackage{setspace}
  - \setstretch{0.9}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(qualtRics)
library(kableExtra)
library(ggthemes)
library(broom)
library(effsize)

theme_set(theme_economist())
```


```{r api-setup, include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)

survey_id <- "SV_cASPdJCJOBdOu1M"

cat("Fetching survey data from Qualtrics...\n")
raw_data <- fetch_survey(survey_id, force_request = TRUE, start_date = "2025-10-07")
cat("Successfully fetched", nrow(raw_data), "responses\n")
```



```{r data-prep, include=FALSE}
complete_data <- raw_data %>%
  filter(Finished == TRUE | Finished == "True" | Finished == 1) %>%
  filter(Status == "IP Address" | Status == 0)

cat("Complete responses:", nrow(complete_data), "\n")

# Function to clean scale values with text anchors
clean_scale <- function(x) {
  x <- as.character(x)
  x <- case_when(
    grepl("Not at all important", x, ignore.case = TRUE) ~ "1",
    grepl("Very important", x, ignore.case = TRUE) ~ "7",
    TRUE ~ x
  )
  return(as.numeric(x))
}

# Find the importance column (may vary based on Qualtrics export)
importance_cols <- names(complete_data)[grepl("importance|percentage", names(complete_data), ignore.case = TRUE)]
importance_col <- importance_cols[1]  # Take first matching column

if(is.null(importance_col) || length(importance_col) == 0) {
  # If no column found with those names, look for Q columns
  q_cols <- names(complete_data)[grepl("^Q[0-9]", names(complete_data))]
  if(length(q_cols) > 0) {
    importance_col <- q_cols[1]
  }
}

cat("Using importance column:", importance_col, "\n")

# Clean the importance ratings
complete_data[[importance_col]] <- clean_scale(complete_data[[importance_col]])

# Extract attribute from embedded field
clean_data <- complete_data %>%
  filter(!is.na(.data[[importance_col]])) %>%
  rename(importance = !!importance_col) %>%
  mutate(
    # Clean attribute text - remove any extra whitespace
    attribute = str_trim(attribute)
  )

cat("\nFinal sample size after cleaning:", nrow(clean_data), "\n")
cat("Number of unique attributes:", n_distinct(clean_data$attribute), "\n")
```

```{r women-comparison}
# Define key attributes
women_attr <- "were women."
racial_attr <- "were racial minorities."

# Get women data
women_data <- clean_data %>%
  filter(attribute == women_attr)

# Get all other attributes EXCLUDING racial minorities
other_attrs_excl_racial <- clean_data %>%
  filter(attribute != women_attr & attribute != racial_attr)

# Calculate statistics for each non-women, non-racial attribute
women_comparisons <- other_attrs_excl_racial %>%
  group_by(attribute) %>%
  group_modify(~ {
    # Get current attribute data
    attr_data <- .x$importance
    women_importance <- women_data$importance

    # Perform t-test
    t_result <- t.test(women_importance, attr_data, var.equal = FALSE)

    # Calculate Cohen's d
    cohen_result <- cohen.d(women_importance, attr_data)

    # Return results
    tibble(
      women_mean = mean(women_importance, na.rm = TRUE),
      women_sd = sd(women_importance, na.rm = TRUE),
      women_n = length(women_importance),
      other_mean = mean(attr_data, na.rm = TRUE),
      other_sd = sd(attr_data, na.rm = TRUE),
      other_n = length(attr_data),
      mean_diff = mean(women_importance, na.rm = TRUE) - mean(attr_data, na.rm = TRUE),
      t_stat = t_result$statistic,
      df = t_result$parameter,
      p_value = t_result$p.value,
      cohens_d = cohen_result$estimate
    )
  }) %>%
  ungroup()

# Format for display
women_table <- women_comparisons %>%
  arrange(abs(cohens_d)) %>%  # Sort by absolute Cohen's d first
  mutate(
    `Women Mean (SD)` = paste0(round(women_mean, 2), " (", round(women_sd, 2), ")"),
    `Other Mean (SD)` = paste0(round(other_mean, 2), " (", round(other_sd, 2), ")"),
    `Difference` = round(mean_diff, 2),
    `t-statistic` = round(t_stat, 2),
    `p-value` = round(p_value, 3),
    `Cohen's d` = round(cohens_d, 2),
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(attribute, `Women Mean (SD)`, `Other Mean (SD)`, `Difference`,
         `t-statistic`, `p-value`, sig, `Cohen's d`)

kable(women_table,
      caption = "Women vs. All Other Attributes (excluding Racial Minorities)",
      format = "latex",
      booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"),
                font_size = 8)
```

```{r racial-comparison}
# Get racial minorities data
racial_data <- clean_data %>%
  filter(attribute == racial_attr)

# Get all other attributes EXCLUDING women and US born
other_attrs_excl_women <- clean_data %>%
  filter(attribute != racial_attr & attribute != women_attr & attribute != "were born in the United States.")

# Calculate statistics for each non-racial, non-women attribute
racial_comparisons <- other_attrs_excl_women %>%
  group_by(attribute) %>%
  group_modify(~ {
    # Get current attribute data
    attr_data <- .x$importance
    racial_importance <- racial_data$importance

    # Perform t-test
    t_result <- t.test(racial_importance, attr_data, var.equal = FALSE)

    # Calculate Cohen's d
    cohen_result <- cohen.d(racial_importance, attr_data)

    # Return results
    tibble(
      racial_mean = mean(racial_importance, na.rm = TRUE),
      racial_sd = sd(racial_importance, na.rm = TRUE),
      racial_n = length(racial_importance),
      other_mean = mean(attr_data, na.rm = TRUE),
      other_sd = sd(attr_data, na.rm = TRUE),
      other_n = length(attr_data),
      mean_diff = mean(racial_importance, na.rm = TRUE) - mean(attr_data, na.rm = TRUE),
      t_stat = t_result$statistic,
      df = t_result$parameter,
      p_value = t_result$p.value,
      cohens_d = cohen_result$estimate
    )
  }) %>%
  ungroup()

# Format for display
racial_table <- racial_comparisons %>%
  arrange(abs(cohens_d)) %>%  # Sort by absolute Cohen's d first
  mutate(
    `Race Mean (SD)` = paste0(round(racial_mean, 2), " (", round(racial_sd, 2), ")"),
    `Other Mean (SD)` = paste0(round(other_mean, 2), " (", round(other_sd, 2), ")"),
    `Difference` = round(mean_diff, 2),
    `t-statistic` = round(t_stat, 2),
    `p-value` = round(p_value, 3),
    `Cohen's d` = round(cohens_d, 2),
    sig = case_when(
      p_value < 0.001 ~ "***",
      p_value < 0.01 ~ "**",
      p_value < 0.05 ~ "*",
      TRUE ~ ""
    )
  ) %>%
  select(attribute, `Race Mean (SD)`, `Other Mean (SD)`, `Difference`,
         `t-statistic`, `p-value`, sig, `Cohen's d`)

kable(racial_table,
      caption = "Racial Minorities vs. All Other Attributes (excluding Women)",
      format = "latex",
      booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position"),
                font_size = 8)
```



