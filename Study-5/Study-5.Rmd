---
title: "Study 5"
subtitle: "2x2 Pool (Women vs Men) × Feedback (Control vs Treatment)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
```

```{r include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)

if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```



```{r include=FALSE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- TRUE

if(USE_API) {
  ## Pull directly from Qualtrics API
  qual_data <- fetch_survey(surveyID='SV_czIz0pd2J1emErs',
                     label = T,
                     convert = F,
                     start_date = "2025-12-02",
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('Study5.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define the categories based on the CEO/Founder stimuli
women <- c("Whitney Wolfe Herd (Founder of Bumble)",
           "Leah Busque (Founder of TaskRabbit)",
           "Melanie Perkins (Founder of Canva)",
           "Julia Hartz (Co-founder of EventBrite)",
           "Arianna Huffington (Founder of Thrive Global)",
           "Lisa Su (CEO of AMD)",
           "Linda Yaccarino (CEO of X)",
           "Kate Johnson (CEO of Lumen Technologies)",
           "Christine Leahy (CEO of CDW)",
           "Kendra Scott (Founder of Kendra Scott)",
           "Sara Blakely (Founder of Spanx)",
           "Oprah Winfrey (Founder of OWN)",
           "Jessica Alba (Founder of The Honest Company)",
           "Jane Fraser (CEO of Citigroup)",
           "Mary Barra (CEO of General Motors)",
           "Gail Boudreaux (CEO of Elevance Health)",
           "Carol Tomé (CEO of UPS)",
           "Michele Buck (CEO of Hershey)")

men <- c("Larry Page (Co-founder of Google)",
         "Mark Zuckerberg (Co-founder of Facebook)",
         "Bill Gates (Co-founder of Microsoft)",
         "Jeff Bezos (Founder of Amazon)",
         "Tim Cook (CEO of Apple)",
         "Sundar Pichai (CEO of Alphabet Inc.)",
         "Satya Nadella (CEO of Microsoft)",
         "Jensen Huang (CEO of NVIDIA)",
         "Andy Jassy (CEO of Amazon)",
         "Daymond John (Founder of FUBU)",
         "Phil Knight (Co-founder of Nike)",
         "Howard Schultz (Founder of Starbucks)",
         "Michael Bloomberg (Co-founder of Bloomberg LP)",
         "Richard Branson (Founder of Virgin Group)",
         "Warren Buffett (CEO of Berkshire Hathaway)",
         "Jamie Dimon (CEO of JPMorgan Chase)",
         "Brian Moynihan (CEO of Bank of America)",
         "Lloyd Blankfein (Former CEO of Goldman Sachs)")

technologists <- c("Whitney Wolfe Herd", "Leah Busque", "Melanie Perkins",
                   "Julia Hartz", "Arianna Huffington",
                   "Lisa Su", "Linda Yaccarino", "Kate Johnson", "Christine Leahy",
                   "Larry Page", "Mark Zuckerberg", "Bill Gates", "Jeff Bezos",
                   "Tim Cook", "Sundar Pichai", "Satya Nadella", "Jensen Huang", "Andy Jassy")

if(USE_API) {
  # Process the API data
  d0 <- qual_data |>
    filter(!is.na(`choice-7`), !is.na(PROLIFIC_PID), Finished==1) |>
    mutate(
      # Treatment assignment (control vs treatment)
      treatment = case_when(cond == "treat" ~ 1, TRUE ~ 0),

      # Pool assignment (women underrepresented vs overrepresented)
      # men_pool = 1 means women underrepresented (25% women)
      # men_pool = 0 means women overrepresented (75% women)
      men_pool = case_when(pool == "men" ~ 1, TRUE ~ 0),

      # Primary DV: Whether the 7th (final) choice is a woman
      female_pick = case_when(`choice-7` %in% women ~ 1, TRUE ~ 0),

      # Count women in base selections (choice-1 through choice-6)
      base_gender = rowSums(across(`choice-1`:`choice-6`, ~ . %in% women)),

      # Tech and founder classifications
      tech_pick = case_when(`choice-7` %in% technologists ~ 1, TRUE ~ 0)
    ) |>
    dplyr::select(treatment, men_pool, cond, pool,
                  female_pick, base_gender, tech_pick,
                  `choice-1`:`choice-7`, race, gender, age)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'Study5.csv', row.names = FALSE, quote = TRUE)
}
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{treatment} & Binary indicator of whether a participant was randomly assigned to treatment condition (1 = treat, 0 = control). \\
\hline
\texttt{men\_pool} & Binary indicator of pool condition where women are underrepresented (1 = men pool/25\% women, 0 = women pool/75\% women). \\
\hline
\texttt{female\_pick} & Binary indicator of whether the 7th (final) selection is a woman (PRIMARY DV). \\
\hline
\texttt{base\_gender} & Count of women selected in the initial 6 choices (0-6). \\
\hline
\texttt{tech\_pick} & Binary indicator of whether the 7th selection is a technologist. \\
\hline
\texttt{choice-1 to choice-7} & The selected CEOs/Founders (choices 1-6 are initial, choice-7 is final DV) \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\end{tabular}
\end{table}

\newpage

## Demographics

```{r echo=FALSE, results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n\n')

## Sample size
cat('Total N:', nrow(d0), '\n\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)


## Race

race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

# Create the final data frame
race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

# Reorder the columns
colnames(race_df) <- c("Percentage", "Race")

# Print the data frame
print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Cell sizes

cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(pool, cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)

## Initial selections (base_gender)

cat('\n\nMean number of women in initial 6 selections: ', round(mean(d0$base_gender), 2), '\n')
cat('SD of women in initial 6 selections: ', round(sd(d0$base_gender), 2), '\n\n')

d0 |>
  dplyr::select(base_gender, cond, pool) |>
  dplyr::group_by(cond, pool) |>
  dplyr::summarize(mean = mean(base_gender), sd = sd(base_gender), n = n(), .groups = "drop")

## Final selection (DV: female_pick)

cat('\n\nProportion who selected a woman for final choice: ', round(mean(d0$female_pick), 3), '\n')
cat('SD: ', round(sd(d0$female_pick), 3), '\n\n')

d0 |>
  dplyr::select(female_pick, cond, pool) |>
  dplyr::group_by(cond, pool) |>
  dplyr::summarize(mean = mean(female_pick), sd = sd(female_pick), n = n(), .groups = "drop")
```

\newpage

## Primary Analysis: 2x2 Interaction

```{r primary-analysis, echo=FALSE, results='markup'}
# Pre-registered analysis to test H1 and H2:
# OLS regression predicting whether participants choose a woman as their 7th panelist
# Predictors: (1) gender feedback condition, (2) women underrepresented pool, (3) interaction
# This allows testing H1 via coefficient on (1) and H2 via coefficient on (3)

model_2x2 <- lm(female_pick ~ treatment * men_pool, data = d0)

cat("=== 2x2 Interaction: Treatment × Women Underrepresented Pool ===\n")
cat("Model: female_pick ~ treatment * men_pool\n")
cat("(men_pool: 1 = women underrepresented, 0 = women overrepresented)\n\n")
robust_summary(model_2x2)
robust_confint(model_2x2)

# Cell means
cat("\n\nCell Means:\n")
d0 |>
  group_by(cond, pool) |>
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Simple Effects by Pool

### Women Underrepresented Pool (Men Pool, 25% Women)

```{r men-pool, echo=FALSE, results='markup'}
# Women underrepresented pool: main effect of treatment
model_men <- lm(female_pick ~ treatment,
                data = d0 %>% filter(men_pool == 1))

cat("=== WOMEN UNDERREPRESENTED POOL (MEN POOL, 25% WOMEN) ===\n")
cat("Model: female_pick ~ treatment\n\n")
robust_summary(model_men)
robust_confint(model_men)

# Cell means
cat("\n\nCell Means - Women Underrepresented Pool:\n")
d0 %>%
  filter(men_pool == 1) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### Women Overrepresented Pool (Women Pool, 75% Women)

```{r women-pool, echo=FALSE, results='markup'}
cat("=== WOMEN OVERREPRESENTED POOL (WOMEN POOL, 75% WOMEN) ===\n\n")

# Main effect model
cat("--- MAIN EFFECT MODEL ---\n")
cat("Model: female_pick ~ treatment\n\n")
model_women <- lm(female_pick ~ treatment,
                 data = d0 %>% filter(men_pool == 0))
robust_summary(model_women)
robust_confint(model_women)

# Cell means by treatment
cat("\n\nCell Means by Treatment:\n")
d0 %>%
  filter(men_pool == 0) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )

# Moderation by participant gender
cat("\n\n--- MODERATION BY PARTICIPANT GENDER ---\n")

# First, check gender distribution
cat("Gender distribution in Women Overrepresented Pool:\n")
d0 %>%
  filter(men_pool == 0) %>%
  group_by(gender) %>%
  summarise(n = n(), .groups = "drop") %>%
  print()

cat("\n")

# Filter to just Woman and Man for cleaner analysis
d_women_pool_binary <- d0 %>%
  filter(men_pool == 0, gender %in% c("Woman", "Man"))

cat("Analysis restricted to Woman and Man participants only\n")
cat("N =", nrow(d_women_pool_binary), "\n\n")

cat("Model: female_pick ~ treatment * gender\n\n")

model_women_gender <- lm(female_pick ~ treatment * gender,
                         data = d_women_pool_binary)

robust_summary(model_women_gender)
robust_confint(model_women_gender)

# Cell means by treatment and gender
cat("\n\nCell Means by Treatment × Participant Gender:\n")
d_women_pool_binary %>%
  group_by(cond, gender) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )

# Simple slopes: Treatment effect for each gender
cat("\n\n--- SIMPLE SLOPES ---\n\n")

# Treatment effect for women participants
cat("Treatment Effect for Women Participants:\n")
model_women_woman <- lm(female_pick ~ treatment,
                        data = d_women_pool_binary %>% filter(gender == "Woman"))
robust_summary(model_women_woman)
cat("Treatment coefficient: ", sprintf("%.4f", coef(model_women_woman)["treatment"]), "\n")
cat("95% CI: [", sprintf("%.4f", robust_confint(model_women_woman)["treatment", 1]),
    ", ", sprintf("%.4f", robust_confint(model_women_woman)["treatment", 2]), "]\n\n", sep = "")

# Treatment effect for men participants
cat("Treatment Effect for Men Participants:\n")
model_women_man <- lm(female_pick ~ treatment,
                      data = d_women_pool_binary %>% filter(gender == "Man"))
robust_summary(model_women_man)
cat("Treatment coefficient: ", sprintf("%.4f", coef(model_women_man)["treatment"]), "\n")
cat("95% CI: [", sprintf("%.4f", robust_confint(model_women_man)["treatment", 1]),
    ", ", sprintf("%.4f", robust_confint(model_women_man)["treatment", 2]), "]\n\n", sep = "")

# Calculate and test difference in treatment effects
cat("--- DIFFERENCE IN TREATMENT EFFECTS ---\n\n")
effect_woman <- coef(model_women_woman)["treatment"]
se_woman <- sqrt(diag(vcovHC(model_women_woman, type = "HC3")))["treatment"]

effect_man <- coef(model_women_man)["treatment"]
se_man <- sqrt(diag(vcovHC(model_women_man, type = "HC3")))["treatment"]

diff_effects <- effect_woman - effect_man
se_diff <- sqrt(se_woman^2 + se_man^2)
z_stat <- diff_effects / se_diff
p_value <- 2 * (1 - pnorm(abs(z_stat)))

cat("Treatment effect (Women participants): ", sprintf("%.4f", effect_woman),
    " (SE = ", sprintf("%.4f", se_woman), ")\n", sep = "")
cat("Treatment effect (Men participants):   ", sprintf("%.4f", effect_man),
    " (SE = ", sprintf("%.4f", se_man), ")\n\n", sep = "")

cat("Difference: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("SE of difference: ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Z-statistic: ", sprintf("%.4f", z_stat), "\n", sep = "")
cat("P-value: ", sprintf("%.4f", p_value), "\n\n", sep = "")

if (p_value < 0.05) {
  cat("CONCLUSION: Participant gender SIGNIFICANTLY moderates the treatment effect (p < 0.05).\n")
} else {
  cat("CONCLUSION: Participant gender does NOT significantly moderate the treatment effect (p >= 0.05).\n")
}
```

\newpage

## Wald Test: Comparing Treatment Effects Across Pools

```{r wald-test, echo=FALSE, results='markup'}
cat("=== WALD TEST: DIFFERENCE IN TREATMENT EFFECTS BETWEEN POOLS ===\n\n")

# Calculate treatment effects for each pool
# Men pool: just the treatment coefficient
effect_men <- coef(model_men)["treatment"]
se_men <- sqrt(diag(vcovHC(model_men, type = "HC3")))["treatment"]

# Women pool: just the treatment coefficient
effect_women <- coef(model_women)["treatment"]
se_women <- sqrt(diag(vcovHC(model_women, type = "HC3")))["treatment"]

# Calculate difference in treatment effects
diff_effects <- effect_men - effect_women

# Standard error of the difference (assuming independence)
se_diff <- sqrt(se_men^2 + se_women^2)

# Wald test statistic
wald_stat <- diff_effects / se_diff

# P-value (two-tailed)
p_value <- 2 * (1 - pnorm(abs(wald_stat)))

# 95% CI for the difference
ci_lower <- diff_effects - 1.96 * se_diff
ci_upper <- diff_effects + 1.96 * se_diff

# Print results
cat("Treatment Effect (Men Pool 25%):   ", sprintf("%.4f", effect_men),
    " (SE = ", sprintf("%.4f", se_men), ")\n", sep = "")
cat("Treatment Effect (Women Pool 75%): ", sprintf("%.4f", effect_women),
    " (SE = ", sprintf("%.4f", se_women), ")\n\n", sep = "")

cat("Difference in Treatment Effects: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("Standard Error of Difference:    ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Wald Statistic (z):              ", sprintf("%.4f", wald_stat), "\n", sep = "")
cat("P-value (two-tailed):            ", sprintf("%.4f", p_value), "\n", sep = "")
cat("95% CI for Difference:           [", sprintf("%.4f", ci_lower), ", ",
    sprintf("%.4f", ci_upper), "]\n\n", sep = "")
```

\newpage

# Visualization

## Interaction Plot: Treatment × Pool

```{r fig-interaction, fig.cap="Effect of Gender Feedback by Pool Condition", fig.width=10, fig.height=8, echo=FALSE}
# Run statistical tests to determine significance levels
test_men <- t.test(female_pick ~ treatment, data=d0 %>% filter(men_pool == 1))
test_women <- t.test(female_pick ~ treatment, data=d0 %>% filter(men_pool == 0))

# Function to get significance stars
get_sig_stars <- function(p_value) {
  if (p_value < 0.001) return("***")
  else if (p_value < 0.01) return("**")
  else if (p_value < 0.05) return("*")
  else return("n.s.")
}

sig_men <- get_sig_stars(test_men$p.value)
sig_women <- get_sig_stars(test_women$p.value)

# Prepare plot data for men pool (women underrepresented, 25% women)
dmen_plot <- d0 %>%
  filter(men_pool == 1) %>%
  dplyr::select(treatment, female_pick) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Prepare plot data for women pool (women overrepresented, 75% women)
dwomen_plot <- d0 %>%
  filter(men_pool == 0) %>%
  dplyr::select(treatment, female_pick) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Combine into single dataframe
df_combined <- bind_rows(
  dmen_plot %>% mutate(Category = "Women Underrepresented\nin Candidate Set"),
  dwomen_plot %>% mutate(Category = "Women Overrepresented\nin Candidate Set")
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('Women Underrepresented\nin Candidate Set', 'Women Overrepresented\nin Candidate Set')))

# Create combined plot
p_combined <- ggplot(df_combined, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 7, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~Category, nrow = 1, strip.position = "bottom") +
  geom_segment(data = df_combined %>% filter(Category == "Women Underrepresented\nin Candidate Set" & Condition == "Treatment"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_segment(data = df_combined %>% filter(Category == "Women Overrepresented\nin Candidate Set" & Condition == "Control"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_text(data = df_combined %>% filter(Category == "Women Underrepresented\nin Candidate Set" & Condition == "Treatment"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_men),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  geom_text(data = df_combined %>% filter(Category == "Women Overrepresented\nin Candidate Set" & Condition == "Control"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_women),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  theme_bw() +
  scale_fill_manual(values = c("#011F5B", "#990000"), labels = c("No gender feedback provided", "Gender feedback provided"), "") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("Control" = "Not\nShown", "Treatment" = "Shown")) +
  labs(x = "", y = "% of Final Selections who Were Women") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.direction = "horizontal",
        legend.text = element_text(size = 18),
        legend.key.size = unit(5, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = 18, color = "black"),
        plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 18, color = "black"),
        strip.text = element_text(size = 18, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

# Display the plot
print(p_combined)

# Save the plot
ggsave("Figure-Study5.pdf", plot = p_combined, width = 10, height = 8, units = "in", device = cairo_pdf, family = "Times New Roman")
ggsave("Figure-Study5.png", plot = p_combined, width = 10, height = 8, units = "in", dpi = 600)
```

\newpage

# Robustness Checks

## Logistic Regression Analyses

```{r logistic-regressions, echo=FALSE, results='markup'}
cat("=======================================================\n")
cat("ROBUSTNESS CHECK: LOGISTIC REGRESSION ANALYSES\n")
cat("=======================================================\n\n")

# H1 Test: Men Pool (Women Underrepresented) Only
cat("--- H1 TEST: MEN POOL (WOMEN UNDERREPRESENTED) ONLY ---\n\n")
logit_men <- glm(female_pick ~ treatment,
                 data = d0 %>% filter(men_pool == 1),
                 family = binomial(link = "logit"))
summary(logit_men)

# Odds ratios and 95% CIs
cat("\n\nOdds Ratios and 95% CIs:\n")
exp(cbind(OR = coef(logit_men), confint(logit_men)))

cat("\n\n")

# H1 & H2 Test: Full 2x2 Interaction
cat("--- H1 & H2 TEST: FULL 2x2 INTERACTION ---\n\n")
logit_2x2 <- glm(female_pick ~ treatment * men_pool,
                 data = d0,
                 family = binomial(link = "logit"))
summary(logit_2x2)

# Odds ratios and 95% CIs
cat("\n\nOdds Ratios and 95% CIs:\n")
exp(cbind(OR = coef(logit_2x2), confint(logit_2x2)))
```

\newpage

## Models with Demographic Controls

```{r demographic-controls, echo=FALSE, results='markup'}
cat("=======================================================\n")
cat("ROBUSTNESS CHECK: MODELS WITH DEMOGRAPHIC CONTROLS\n")
cat("=======================================================\n\n")

# Create demographic control variables
d0_controls <- d0 %>%
  mutate(
    # Binary gender indicator: man (=1) vs. not-man (=0)
    man = case_when(gender == "Man" ~ 1, TRUE ~ 0),

    # Binary race indicator: White (=1) vs. non-White (=0)
    white = case_when(race == "White" ~ 1, TRUE ~ 0),

    # Missing indicators
    gender_missing = case_when(is.na(gender) ~ 1, TRUE ~ 0),
    race_missing = case_when(is.na(race) ~ 1, TRUE ~ 0),
    age_missing = case_when(is.na(age) ~ 1, TRUE ~ 0),

    # Impute missing values with 0 for regression
    man = ifelse(is.na(man), 0, man),
    white = ifelse(is.na(white), 0, white),
    age_clean = ifelse(is.na(age), 0, age)
  )

cat("Demographic Variable Summary:\n")
cat("Man (1=Man, 0=Not-Man): ", sprintf("%.1f%%", mean(d0_controls$man, na.rm=T) * 100), "\n")
cat("White (1=White, 0=Non-White): ", sprintf("%.1f%%", mean(d0_controls$white, na.rm=T) * 100), "\n")
cat("Age (mean): ", sprintf("%.2f", mean(d0_controls$age, na.rm=T)), "\n\n")

cat("Missing Data:\n")
cat("Gender missing: ", sum(d0_controls$gender_missing), "\n")
cat("Race missing: ", sum(d0_controls$race_missing), "\n")
cat("Age missing: ", sum(d0_controls$age_missing), "\n\n")

# Primary model with demographic controls
cat("--- PRIMARY MODEL WITH DEMOGRAPHIC CONTROLS ---\n")
cat("Model: female_pick ~ treatment * men_pool + man + white + age + missing indicators\n\n")

model_2x2_controls <- lm(female_pick ~ treatment * men_pool +
                          man + white + age_clean +
                          gender_missing + race_missing + age_missing,
                        data = d0_controls)

robust_summary(model_2x2_controls)
robust_confint(model_2x2_controls)
```

\newpage

## Dropout Sensitivity Analyses

```{r dropout-sensitivity, echo=FALSE, results='markup'}
cat("=======================================================\n")
cat("ROBUSTNESS CHECK: DROPOUT SENSITIVITY ANALYSES\n")
cat("=======================================================\n\n")

# Note: For the pilot, we need to check if there are any dropouts
# Dropouts are participants who were assigned to condition but didn't select a 7th panelist

# Check for dropouts in the original qual_data
if(USE_API & exists("qual_data")) {
  # Count participants who finished but are missing choice-7
  dropouts_missing_choice7 <- qual_data %>%
    filter(Finished == 1, is.na(`choice-7`)) %>%
    nrow()

  # Count participants who didn't finish
  dropouts_not_finished <- qual_data %>%
    filter(Finished != 1) %>%
    nrow()

  total_dropouts <- dropouts_missing_choice7 + dropouts_not_finished

  cat("Dropout Summary:\n")
  cat("Participants who finished but didn't select choice-7: ", dropouts_missing_choice7, "\n")
  cat("Participants who didn't finish: ", dropouts_not_finished, "\n")
  cat("Total dropouts after assignment: ", total_dropouts, "\n\n")

  if(total_dropouts > 0) {
    cat("Running sensitivity analyses...\n\n")

    # Scenario 1: Assume all dropouts chose a man
    cat("--- SCENARIO 1: ASSUME DROPOUTS CHOSE MAN ---\n\n")
    d0_dropout_man <- qual_data %>%
      filter(!is.na(PROLIFIC_PID), Finished==1) %>%
      mutate(
        treatment = case_when(cond == "treat" ~ 1, TRUE ~ 0),
        men_pool = case_when(pool == "men" ~ 1, TRUE ~ 0),
        # If choice-7 is missing, code as man (0)
        female_pick = case_when(
          is.na(`choice-7`) ~ 0,
          `choice-7` %in% women ~ 1,
          TRUE ~ 0
        )
      )

    model_dropout_man <- lm(female_pick ~ treatment * men_pool, data = d0_dropout_man)
    cat("Model: female_pick ~ treatment * men_pool\n\n")
    robust_summary(model_dropout_man)
    robust_confint(model_dropout_man)

    cat("\n\n")

    # Scenario 2: Assume all dropouts chose a woman
    cat("--- SCENARIO 2: ASSUME DROPOUTS CHOSE WOMAN ---\n\n")
    d0_dropout_woman <- qual_data %>%
      filter(!is.na(PROLIFIC_PID), Finished==1) %>%
      mutate(
        treatment = case_when(cond == "treat" ~ 1, TRUE ~ 0),
        men_pool = case_when(pool == "men" ~ 1, TRUE ~ 0),
        # If choice-7 is missing, code as woman (1)
        female_pick = case_when(
          is.na(`choice-7`) ~ 1,
          `choice-7` %in% women ~ 1,
          TRUE ~ 0
        )
      )

    model_dropout_woman <- lm(female_pick ~ treatment * men_pool, data = d0_dropout_woman)
    cat("Model: female_pick ~ treatment * men_pool\n\n")
    robust_summary(model_dropout_woman)
    robust_confint(model_dropout_woman)

  } else {
    cat("No dropouts detected after assignment to condition.\n")
    cat("Sensitivity analyses not needed.\n")
  }
} else {
  cat("Note: Dropout sensitivity analysis requires API data (qual_data).\n")
  cat("If using CSV mode, please check for dropouts manually.\n")
}
```
