---
title: "Study 5"
subtitle: "2x2 Pool (Women vs Men) × Feedback (Control vs Treatment)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
library(mediation)
```

```{r include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)

if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```



```{r include=FALSE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- TRUE

if(USE_API) {
  ## Pull directly from Qualtrics API (new survey with mechanism scales)
  qual_data <- fetch_survey(surveyID='SV_czIz0pd2J1emErs',
                     label = T,
                     convert = F,
                     start_date = "2025-12-03",
                     end_date = "2025-12-04",
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('Study5.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define the categories based on the CEO/Founder stimuli
women <- c("Whitney Wolfe Herd (Founder of Bumble)",
           "Leah Busque (Founder of TaskRabbit)",
           "Melanie Perkins (Founder of Canva)",
           "Julia Hartz (Co-founder of EventBrite)",
           "Arianna Huffington (Founder of Thrive Global)",
           "Lisa Su (CEO of AMD)",
           "Linda Yaccarino (CEO of X)",
           "Kate Johnson (CEO of Lumen Technologies)",
           "Christine Leahy (CEO of CDW)",
           "Kendra Scott (Founder of Kendra Scott)",
           "Sara Blakely (Founder of Spanx)",
           "Oprah Winfrey (Founder of OWN)",
           "Jessica Alba (Founder of The Honest Company)",
           "Jane Fraser (CEO of Citigroup)",
           "Mary Barra (CEO of General Motors)",
           "Gail Boudreaux (CEO of Elevance Health)",
           "Carol Tomé (CEO of UPS)",
           "Michele Buck (CEO of Hershey)")

men <- c("Larry Page (Co-founder of Google)",
         "Mark Zuckerberg (Co-founder of Facebook)",
         "Bill Gates (Co-founder of Microsoft)",
         "Jeff Bezos (Founder of Amazon)",
         "Tim Cook (CEO of Apple)",
         "Sundar Pichai (CEO of Alphabet Inc.)",
         "Satya Nadella (CEO of Microsoft)",
         "Jensen Huang (CEO of NVIDIA)",
         "Andy Jassy (CEO of Amazon)",
         "Daymond John (Founder of FUBU)",
         "Phil Knight (Co-founder of Nike)",
         "Howard Schultz (Founder of Starbucks)",
         "Michael Bloomberg (Co-founder of Bloomberg LP)",
         "Richard Branson (Founder of Virgin Group)",
         "Warren Buffett (CEO of Berkshire Hathaway)",
         "Jamie Dimon (CEO of JPMorgan Chase)",
         "Brian Moynihan (CEO of Bank of America)",
         "Lloyd Blankfein (Former CEO of Goldman Sachs)")

technologists <- c("Whitney Wolfe Herd", "Leah Busque", "Melanie Perkins",
                   "Julia Hartz", "Arianna Huffington",
                   "Lisa Su", "Linda Yaccarino", "Kate Johnson", "Christine Leahy",
                   "Larry Page", "Mark Zuckerberg", "Bill Gates", "Jeff Bezos",
                   "Tim Cook", "Sundar Pichai", "Satya Nadella", "Jensen Huang", "Andy Jassy")

  # Function to recode 7-point Likert labels to numeric
  recode_likert <- function(x) {
    case_when(
      x == "Strongly disagree" ~ 1,
      x == "Disagree" ~ 2,
      x == "Somewhat disagree" ~ 3,
      x == "Neither agree nor disagree" ~ 4,
      x == "Somewhat agree" ~ 5,
      x == "Agree" ~ 6,
      x == "Strongly agree" ~ 7,
      TRUE ~ NA_real_
    )
  }

if(USE_API) {
  # Process the API data
  d0 <- qual_data |>
    filter(!is.na(`choice-7`), !is.na(PROLIFIC_PID), Finished==1) |>
    mutate(
      # Treatment assignment (control vs treatment)
      treatment = case_when(cond == "treat" ~ 1, TRUE ~ 0),

      # Pool assignment (women underrepresented vs overrepresented)
      # men_pool = 1 means women underrepresented (25% women)
      # men_pool = 0 means women overrepresented (75% women)
      men_pool = case_when(pool == "men" ~ 1, TRUE ~ 0),

      # Primary DV: Whether the 7th (final) choice is a woman
      female_pick = case_when(`choice-7` %in% women ~ 1, TRUE ~ 0),

      # Count women in base selections (choice-1 through choice-6)
      base_gender = rowSums(across(`choice-1`:`choice-6`, ~ . %in% women)),

      # Tech and founder classifications
      tech_pick = case_when(`choice-7` %in% technologists ~ 1, TRUE ~ 0),

      # Mechanism scales - recode to numeric (1-7)
      # Fairness items
      fair1_num = recode_likert(fair1),
      fair2_num = recode_likert(fair2),
      fair3_num = recode_likert(fair3),

      # Internal motivation to respond without prejudice
      I1_num = recode_likert(I1),
      I2_num = recode_likert(I2),
      I3_num = recode_likert(I3),
      I4_num = recode_likert(I4),

      # External motivation to respond without prejudice
      E1_num = recode_likert(E1),
      E2_num = recode_likert(E2),
      E3_num = recode_likert(E3)
    ) |>
    # Create scale composites
    rowwise() |>
    mutate(
      fairness = mean(c(fair1_num, fair2_num, fair3_num), na.rm = TRUE),
      internal_motivation = mean(c(I1_num, I2_num, I3_num, I4_num), na.rm = TRUE),
      external_motivation = mean(c(E1_num, E2_num, E3_num), na.rm = TRUE)
    ) |>
    ungroup() |>
    dplyr::select(treatment, men_pool, cond, pool,
                  female_pick, base_gender, tech_pick,
                  `choice-1`:`choice-7`, race, gender, age,
                  fair1_num, fair2_num, fair3_num, fairness,
                  I1_num, I2_num, I3_num, I4_num, internal_motivation,
                  E1_num, E2_num, E3_num, external_motivation)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'Study5.csv', row.names = FALSE, quote = TRUE)
}
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{treatment} & Binary indicator of whether a participant was randomly assigned to treatment condition (1 = treat, 0 = control). \\
\hline
\texttt{men\_pool} & Binary indicator of pool condition where women are underrepresented (1 = men pool/25\% women, 0 = women pool/75\% women). \\
\hline
\texttt{female\_pick} & Binary indicator of whether the 7th (final) selection is a woman (PRIMARY DV). \\
\hline
\texttt{base\_gender} & Count of women selected in the initial 6 choices (0-6). \\
\hline
\texttt{tech\_pick} & Binary indicator of whether the 7th selection is a technologist. \\
\hline
\texttt{choice-1 to choice-7} & The selected CEOs/Founders (choices 1-6 are initial, choice-7 is final DV) \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\end{tabular}
\end{table}

\newpage

## Demographics

```{r echo=FALSE, results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n\n')

## Sample size
cat('Total N:', nrow(d0), '\n\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)


## Race

race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

# Create the final data frame
race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

# Reorder the columns
colnames(race_df) <- c("Percentage", "Race")

# Print the data frame
print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Cell sizes

cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(pool, cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)

## Initial selections (base_gender)

cat('\n\nMean number of women in initial 6 selections: ', round(mean(d0$base_gender), 2), '\n')
cat('SD of women in initial 6 selections: ', round(sd(d0$base_gender), 2), '\n\n')

d0 |>
  dplyr::select(base_gender, cond, pool) |>
  dplyr::group_by(cond, pool) |>
  dplyr::summarize(mean = mean(base_gender), sd = sd(base_gender), n = n(), .groups = "drop")

## Final selection (DV: female_pick)

cat('\n\nProportion who selected a woman for final choice: ', round(mean(d0$female_pick), 3), '\n')
cat('SD: ', round(sd(d0$female_pick), 3), '\n\n')

d0 |>
  dplyr::select(female_pick, cond, pool) |>
  dplyr::group_by(cond, pool) |>
  dplyr::summarize(mean = mean(female_pick), sd = sd(female_pick), n = n(), .groups = "drop")
```

\newpage

## Primary Analysis: 2x2 Interaction

```{r primary-analysis, echo=FALSE, results='markup'}
# Pre-registered analysis to test H1 and H2:
# OLS regression predicting whether participants choose a woman as their 7th panelist
# Predictors: (1) gender feedback condition, (2) women underrepresented pool, (3) interaction
# This allows testing H1 via coefficient on (1) and H2 via coefficient on (3)

model_2x2 <- lm(female_pick ~ treatment * men_pool, data = d0)

cat("=== 2x2 Interaction: Treatment × Women Underrepresented Pool ===\n")
cat("Model: female_pick ~ treatment * men_pool\n")
cat("(men_pool: 1 = women underrepresented, 0 = women overrepresented)\n\n")
robust_summary(model_2x2)
robust_confint(model_2x2)

# Cell means
cat("\n\nCell Means:\n")
d0 |>
  group_by(cond, pool) |>
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Simple Effects by Pool

### Women Underrepresented Pool (Men Pool, 25% Women)

```{r men-pool, echo=FALSE, results='markup'}
# Women underrepresented pool: main effect of treatment
model_men <- lm(female_pick ~ treatment,
                data = d0 %>% filter(men_pool == 1))

cat("=== WOMEN UNDERREPRESENTED POOL (MEN POOL, 25% WOMEN) ===\n")
cat("Model: female_pick ~ treatment\n\n")
robust_summary(model_men)
robust_confint(model_men)

# Cell means
cat("\n\nCell Means - Women Underrepresented Pool:\n")
d0 %>%
  filter(men_pool == 1) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### Women Overrepresented Pool (Women Pool, 75% Women)

```{r women-pool, echo=FALSE, results='markup'}
cat("=== WOMEN OVERREPRESENTED POOL (WOMEN POOL, 75% WOMEN) ===\n\n")

# Main effect model
cat("--- MAIN EFFECT MODEL ---\n")
cat("Model: female_pick ~ treatment\n\n")
model_women <- lm(female_pick ~ treatment,
                 data = d0 %>% filter(men_pool == 0))
robust_summary(model_women)
robust_confint(model_women)

# Cell means by treatment
cat("\n\nCell Means by Treatment:\n")
d0 %>%
  filter(men_pool == 0) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )

```

\newpage

## Wald Test: Comparing Treatment Effects Across Pools

```{r wald-test, echo=FALSE, results='markup'}
cat("=== WALD TEST: DIFFERENCE IN TREATMENT EFFECTS BETWEEN POOLS ===\n\n")

# Calculate treatment effects for each pool
# Men pool: just the treatment coefficient
effect_men <- coef(model_men)["treatment"]
se_men <- sqrt(diag(vcovHC(model_men, type = "HC3")))["treatment"]

# Women pool: just the treatment coefficient
effect_women <- coef(model_women)["treatment"]
se_women <- sqrt(diag(vcovHC(model_women, type = "HC3")))["treatment"]

# Calculate difference in treatment effects
diff_effects <- effect_men - effect_women

# Standard error of the difference (assuming independence)
se_diff <- sqrt(se_men^2 + se_women^2)

# Wald test statistic
wald_stat <- diff_effects / se_diff

# P-value (two-tailed)
p_value <- 2 * (1 - pnorm(abs(wald_stat)))

# 95% CI for the difference
ci_lower <- diff_effects - 1.96 * se_diff
ci_upper <- diff_effects + 1.96 * se_diff

# Print results
cat("Treatment Effect (Men Pool 25%):   ", sprintf("%.4f", effect_men),
    " (SE = ", sprintf("%.4f", se_men), ")\n", sep = "")
cat("Treatment Effect (Women Pool 75%): ", sprintf("%.4f", effect_women),
    " (SE = ", sprintf("%.4f", se_women), ")\n\n", sep = "")

cat("Difference in Treatment Effects: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("Standard Error of Difference:    ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Wald Statistic (z):              ", sprintf("%.4f", wald_stat), "\n", sep = "")
cat("P-value (two-tailed):            ", sprintf("%.4f", p_value), "\n", sep = "")
cat("95% CI for Difference:           [", sprintf("%.4f", ci_lower), ", ",
    sprintf("%.4f", ci_upper), "]\n\n", sep = "")
```

\newpage

# Visualization

## Interaction Plot: Treatment × Pool

```{r fig-interaction, fig.cap="Effect of Gender Feedback by Pool Condition", fig.width=10, fig.height=8, echo=FALSE}
# Run statistical tests to determine significance levels
test_men <- t.test(female_pick ~ treatment, data=d0 %>% filter(men_pool == 1))
test_women <- t.test(female_pick ~ treatment, data=d0 %>% filter(men_pool == 0))

# Function to get significance stars
get_sig_stars <- function(p_value) {
  if (p_value < 0.001) return("***")
  else if (p_value < 0.01) return("**")
  else if (p_value < 0.05) return("*")
  else return("n.s.")
}

sig_men <- get_sig_stars(test_men$p.value)
sig_women <- get_sig_stars(test_women$p.value)

# Prepare plot data for men pool (women underrepresented, 25% women)
dmen_plot <- d0 %>%
  filter(men_pool == 1) %>%
  dplyr::select(treatment, female_pick) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Prepare plot data for women pool (women overrepresented, 75% women)
dwomen_plot <- d0 %>%
  filter(men_pool == 0) %>%
  dplyr::select(treatment, female_pick) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Combine into single dataframe
df_combined <- bind_rows(
  dmen_plot %>% mutate(Category = "Women Underrepresented\nin Candidate Set"),
  dwomen_plot %>% mutate(Category = "Women Overrepresented\nin Candidate Set")
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('Women Underrepresented\nin Candidate Set', 'Women Overrepresented\nin Candidate Set')))

# Create combined plot
p_combined <- ggplot(df_combined, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 7, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~Category, nrow = 1, strip.position = "bottom") +
  geom_segment(data = df_combined %>% filter(Category == "Women Underrepresented\nin Candidate Set" & Condition == "Treatment"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_segment(data = df_combined %>% filter(Category == "Women Overrepresented\nin Candidate Set" & Condition == "Control"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_text(data = df_combined %>% filter(Category == "Women Underrepresented\nin Candidate Set" & Condition == "Treatment"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_men),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  geom_text(data = df_combined %>% filter(Category == "Women Overrepresented\nin Candidate Set" & Condition == "Control"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_women),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  theme_bw() +
  scale_fill_manual(values = c("#011F5B", "#990000"), labels = c("No gender feedback provided", "Gender feedback provided"), "") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("Control" = "Not\nShown", "Treatment" = "Shown")) +
  labs(x = "", y = "% of Final Selections who Were Women") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.direction = "horizontal",
        legend.text = element_text(size = 18),
        legend.key.size = unit(5, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = 18, color = "black"),
        plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 18, color = "black"),
        strip.text = element_text(size = 18, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

# Display the plot
print(p_combined)

# Save the plot
ggsave("Figure-Study4.pdf", plot = p_combined, width = 10, height = 8, units = "in", device = cairo_pdf, family = "Times New Roman")
ggsave("Figure-Study4.png", plot = p_combined, width = 10, height = 8, units = "in", dpi = 600)
```

\newpage


# Mechanism Analysis

## Scale Descriptives

```{r scale-descriptives, echo=FALSE, results='markup'}
cat("=======================================================\n")
cat("MECHANISM SCALE DESCRIPTIVES\n")
cat("=======================================================\n\n")

# Check if scales are available
if(all(c("fairness", "internal_motivation", "external_motivation") %in% names(d0))) {

  # Overall descriptives
  cat("=== OVERALL SCALE DESCRIPTIVES ===\n\n")

  cat("Fairness Scale (fair1, fair2, fair3):\n")
  cat("  Mean:", round(mean(d0$fairness, na.rm=T), 3), "\n")
  cat("  SD:", round(sd(d0$fairness, na.rm=T), 3), "\n")
  cat("  N (non-missing):", sum(!is.na(d0$fairness)), "\n")
  cat("  Alpha:", round(psych::alpha(d0[, c("fair1_num", "fair2_num", "fair3_num")])$total$raw_alpha, 3), "\n\n")

  cat("Internal Motivation Scale (I1, I2, I3, I4):\n")
  cat("  Mean:", round(mean(d0$internal_motivation, na.rm=T), 3), "\n")
  cat("  SD:", round(sd(d0$internal_motivation, na.rm=T), 3), "\n")
  cat("  N (non-missing):", sum(!is.na(d0$internal_motivation)), "\n")
  cat("  Alpha:", round(psych::alpha(d0[, c("I1_num", "I2_num", "I3_num", "I4_num")])$total$raw_alpha, 3), "\n\n")

  cat("External Motivation Scale (E1, E2, E3):\n")
  cat("  Mean:", round(mean(d0$external_motivation, na.rm=T), 3), "\n")
  cat("  SD:", round(sd(d0$external_motivation, na.rm=T), 3), "\n")
  cat("  N (non-missing):", sum(!is.na(d0$external_motivation)), "\n")
  cat("  Alpha:", round(psych::alpha(d0[, c("E1_num", "E2_num", "E3_num")])$total$raw_alpha, 3), "\n\n")

  # By condition
  cat("=== SCALE MEANS BY CONDITION ===\n\n")

  d0 |>
    filter(!is.na(fairness)) |>
    group_by(pool, cond) |>
    summarise(
      n = n(),
      fairness_m = round(mean(fairness, na.rm=T), 2),
      fairness_sd = round(sd(fairness, na.rm=T), 2),
      internal_m = round(mean(internal_motivation, na.rm=T), 2),
      internal_sd = round(sd(internal_motivation, na.rm=T), 2),
      external_m = round(mean(external_motivation, na.rm=T), 2),
      external_sd = round(sd(external_motivation, na.rm=T), 2),
      .groups = "drop"
    ) |>
    print()

} else {
  cat("Mechanism scales not available in current data.\n")
}
```

\newpage

## Mediation Analysis: Women Overrepresented Pool

```{r mediation-analysis, echo=TRUE, results='markup'}
# Set seed for reproducibility
set.seed(123)

# Filter to women overrepresented pool only
d_women_pool <- d0 |> filter(men_pool == 0, !is.na(fairness))

cat("=======================================================\n")
cat("MEDIATION ANALYSIS: WOMEN OVERREPRESENTED POOL\n")
cat("=======================================================\n\n")

cat("Sample size for mediation analysis:", nrow(d_women_pool), "\n\n")

# Define function for Sobel Test
sobel_test <- function(med.fit, out.fit, mediator) {
  med.se <- sqrt(diag(vcovHC(med.fit)))[mediator]
  out.se <- sqrt(diag(vcovHC(out.fit)))[mediator]
  sobel_test_statistic <- coef(out.fit)[mediator] / sqrt(vcovHC(out.fit)[mediator, mediator])
  sobel_p_value <- 2 * (1 - pnorm(abs(sobel_test_statistic)))
  list(statistic = sobel_test_statistic, p_value = sobel_p_value, se = out.se)
}

# -----------------------------
# Fairness Analysis
# -----------------------------

# Direct effect model
dir.fit.fairness <- lm(female_pick ~ treatment, data = d_women_pool)

# Mediator model (a path)
med.fit.fairness <- lm(fairness ~ treatment, data = d_women_pool)

# Outcome model including mediator (b path)
out.fit.fairness <- lm(female_pick ~ treatment + fairness, data = d_women_pool)

# Mediation analysis using Imai's mediation package
med.out.fairness <- mediate(med.fit.fairness, out.fit.fairness, boot = TRUE,
                            treat = "treatment", boot.ci.type = "perc", mediator = "fairness", sims = 10000)

# Sensitivity analysis
sens.out.fairness <- medsens(med.out.fairness, rho.by = 0.01, eps = .01, effect.type = "indirect", sims = 10000)

# Sobel test for fairness
sobel.fairness <- sobel_test(med.fit.fairness, out.fit.fairness, "fairness")

# Print and visualize results for fairness
cat("\n--- FAIRNESS MEDIATION ---\n\n")
cat("Sobel test for Fairness\n")
print(sobel.fairness)
summary(med.out.fairness)
plot(sens.out.fairness)

# -----------------------------
# Internal Motivation Analysis
# -----------------------------

# Mediator model (a path)
med.fit.internal <- lm(internal_motivation ~ treatment, data = d_women_pool)

# Outcome model including mediator (b path)
out.fit.internal <- lm(female_pick ~ treatment + internal_motivation, data = d_women_pool)

# Mediation analysis
med.out.internal <- mediate(med.fit.internal, out.fit.internal, boot = TRUE,
                            treat = "treatment", boot.ci.type = "perc", mediator = "internal_motivation", sims = 10000)

# Sensitivity analysis
sens.out.internal <- medsens(med.out.internal, rho.by = 0.01, eps = .01, effect.type = "indirect", sims = 10000)

# Sobel test for internal motivation
sobel.internal <- sobel_test(med.fit.internal, out.fit.internal, "internal_motivation")

# Print and visualize results for internal motivation
cat("\n--- INTERNAL MOTIVATION MEDIATION ---\n\n")
cat("Sobel test for Internal Motivation\n")
print(sobel.internal)
summary(med.out.internal)
plot(sens.out.internal)

# -----------------------------
# External Motivation Analysis
# -----------------------------

# Mediator model (a path)
med.fit.external <- lm(external_motivation ~ treatment, data = d_women_pool)

# Outcome model including mediator (b path)
out.fit.external <- lm(female_pick ~ treatment + external_motivation, data = d_women_pool)

# Mediation analysis
med.out.external <- mediate(med.fit.external, out.fit.external, boot = TRUE,
                            treat = "treatment", boot.ci.type = "perc", mediator = "external_motivation", sims = 10000)

# Sensitivity analysis
sens.out.external <- medsens(med.out.external, rho.by = 0.01, eps = .01, effect.type = "indirect", sims = 10000)

# Sobel test for external motivation
sobel.external <- sobel_test(med.fit.external, out.fit.external, "external_motivation")

# Print and visualize results for external motivation
cat("\n--- EXTERNAL MOTIVATION MEDIATION ---\n\n")
cat("Sobel test for External Motivation\n")
print(sobel.external)
summary(med.out.external)
plot(sens.out.external)

# ---------------------------------
# Combined Multiple Mediation Model
# ---------------------------------

# Compute the correlation coefficient and p-value between mediators
cat("\n--- MEDIATOR CORRELATIONS ---\n\n")
cor_fair_int <- cor.test(d_women_pool$fairness, d_women_pool$internal_motivation)
cor_fair_ext <- cor.test(d_women_pool$fairness, d_women_pool$external_motivation)
cor_int_ext <- cor.test(d_women_pool$internal_motivation, d_women_pool$external_motivation)

cat("Correlation (Fairness, Internal):", round(cor_fair_int$estimate, 3), "p =", round(cor_fair_int$p.value, 4), "\n")
cat("Correlation (Fairness, External):", round(cor_fair_ext$estimate, 3), "p =", round(cor_fair_ext$p.value, 4), "\n")
cat("Correlation (Internal, External):", round(cor_int_ext$estimate, 3), "p =", round(cor_int_ext$p.value, 4), "\n\n")

# Building combined outcome model with all mediators
out.fit.combined <- lm(female_pick ~ treatment + fairness + internal_motivation + external_motivation, data = d_women_pool)

# Run combined mediation analyses
med.out.combined.fairness <- mediate(med.fit.fairness, out.fit.combined, boot = TRUE,
                                     treat = "treatment", boot.ci.type = "perc", mediator = "fairness", sims = 10000)
med.out.combined.internal <- mediate(med.fit.internal, out.fit.combined, boot = TRUE,
                                     treat = "treatment", boot.ci.type = "perc", mediator = "internal_motivation", sims = 10000)
med.out.combined.external <- mediate(med.fit.external, out.fit.combined, boot = TRUE,
                                     treat = "treatment", boot.ci.type = "perc", mediator = "external_motivation", sims = 10000)

# Summarize and print the results for combined analysis
cat("\n--- COMBINED MULTIPLE MEDIATION MODEL RESULTS ---\n\n")
cat("Fairness (controlling for other mediators):\n")
summary(med.out.combined.fairness)
cat("\nInternal Motivation (controlling for other mediators):\n")
summary(med.out.combined.internal)
cat("\nExternal Motivation (controlling for other mediators):\n")
summary(med.out.combined.external)
```

\newpage

## Mediation Path Summary

```{r path-summary, echo=FALSE, results='markup'}
cat("=======================================================\n")
cat("MEDIATION PATH SUMMARY: WOMEN OVERREPRESENTED POOL\n")
cat("=======================================================\n\n")

cat("N =", nrow(d_women_pool), "\n\n")

# c path (total effect)
cat("=== TOTAL EFFECT (c path) ===\n")
cat("Model: female_pick ~ treatment\n\n")
robust_summary(dir.fit.fairness)
robust_confint(dir.fit.fairness)

# a paths (treatment -> mediators)
cat("\n\n=== a PATHS (Treatment -> Mediators) ===\n\n")

cat("--- Fairness ---\n")
cat("Model: fairness ~ treatment\n")
cat("a =", round(coef(med.fit.fairness)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(med.fit.fairness, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(med.fit.fairness)$coefficients["treatment", "Pr(>|t|)"], 4), "\n\n")

cat("--- Internal Motivation ---\n")
cat("Model: internal_motivation ~ treatment\n")
cat("a =", round(coef(med.fit.internal)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(med.fit.internal, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(med.fit.internal)$coefficients["treatment", "Pr(>|t|)"], 4), "\n\n")

cat("--- External Motivation ---\n")
cat("Model: external_motivation ~ treatment\n")
cat("a =", round(coef(med.fit.external)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(med.fit.external, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(med.fit.external)$coefficients["treatment", "Pr(>|t|)"], 4), "\n")

# b and c' paths (mediator -> DV controlling for treatment)
cat("\n\n=== b PATHS (Mediator -> DV) & c' PATHS (Direct Effects) ===\n\n")

cat("--- Fairness ---\n")
cat("Model: female_pick ~ treatment + fairness\n")
cat("b (fairness) =", round(coef(out.fit.fairness)["fairness"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.fairness, type = "HC3")))["fairness"], 4), "\n")
cat("p =", round(robust_summary(out.fit.fairness)$coefficients["fairness", "Pr(>|t|)"], 4), "\n")
cat("c' (direct) =", round(coef(out.fit.fairness)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.fairness, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(out.fit.fairness)$coefficients["treatment", "Pr(>|t|)"], 4), "\n\n")

cat("--- Internal Motivation ---\n")
cat("Model: female_pick ~ treatment + internal_motivation\n")
cat("b (internal) =", round(coef(out.fit.internal)["internal_motivation"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.internal, type = "HC3")))["internal_motivation"], 4), "\n")
cat("p =", round(robust_summary(out.fit.internal)$coefficients["internal_motivation", "Pr(>|t|)"], 4), "\n")
cat("c' (direct) =", round(coef(out.fit.internal)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.internal, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(out.fit.internal)$coefficients["treatment", "Pr(>|t|)"], 4), "\n\n")

cat("--- External Motivation ---\n")
cat("Model: female_pick ~ treatment + external_motivation\n")
cat("b (external) =", round(coef(out.fit.external)["external_motivation"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.external, type = "HC3")))["external_motivation"], 4), "\n")
cat("p =", round(robust_summary(out.fit.external)$coefficients["external_motivation", "Pr(>|t|)"], 4), "\n")
cat("c' (direct) =", round(coef(out.fit.external)["treatment"], 4), "\n")
cat("SE =", round(sqrt(diag(vcovHC(out.fit.external, type = "HC3")))["treatment"], 4), "\n")
cat("p =", round(robust_summary(out.fit.external)$coefficients["treatment", "Pr(>|t|)"], 4), "\n")

# Summary table
cat("\n\n=== BOOTSTRAP INDIRECT EFFECTS SUMMARY (10,000 simulations) ===\n\n")

summary_table <- data.frame(
  Mediator = c("Fairness", "Internal Motivation", "External Motivation"),
  a_path = c(round(coef(med.fit.fairness)["treatment"], 3),
             round(coef(med.fit.internal)["treatment"], 3),
             round(coef(med.fit.external)["treatment"], 3)),
  b_path = c(round(coef(out.fit.fairness)["fairness"], 3),
             round(coef(out.fit.internal)["internal_motivation"], 3),
             round(coef(out.fit.external)["external_motivation"], 3)),
  ACME = c(round(med.out.fairness$d0, 4),
           round(med.out.internal$d0, 4),
           round(med.out.external$d0, 4)),
  ACME_CI_lower = c(round(med.out.fairness$d0.ci[1], 4),
                    round(med.out.internal$d0.ci[1], 4),
                    round(med.out.external$d0.ci[1], 4)),
  ACME_CI_upper = c(round(med.out.fairness$d0.ci[2], 4),
                    round(med.out.internal$d0.ci[2], 4),
                    round(med.out.external$d0.ci[2], 4)),
  ACME_p = c(round(med.out.fairness$d0.p, 4),
             round(med.out.internal$d0.p, 4),
             round(med.out.external$d0.p, 4))
)

print(summary_table)

cat("\nACME = Average Causal Mediation Effect (indirect effect)\n")
cat("CI = 95% Percentile Bootstrap Confidence Interval\n")
```
