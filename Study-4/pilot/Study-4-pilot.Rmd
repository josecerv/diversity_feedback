---
title: "Study 4 Pilot"
subtitle: "2x2 Base Rate (20% vs 80% Women) × Feedback (Control vs Treatment)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
library(mediation)
library(boot)
```

```{r include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)

if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```



```{r include=FALSE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- TRUE

if(USE_API) {
  ## Pull directly from Qualtrics API
  qual_data <- fetch_survey(surveyID='SV_23LXrPc8hyt0hHo',
                     label = T,
                     convert = F,
                     start_date = "2025-11-17",
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('Study-4-pilot.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define the categories based on the experts (from Study 1 - NPR experts)
women <- c('Emily Kwong', 'Moira Gunn', 'Brittany Luse',
           'Zoe Kleinman', 'Davar Ardalan', 'Jane Barrett')

under_50 <- c('Bobby Allyn', 'Emily Kwong', 'Paris Marx',
              'Kevin Roose', 'Ezra Eeman')

west_coast <- c('Erik Brynjolfsson', 'Moira Gunn', 'Ethan Mollick',
                'Ed Zitron', 'Kevin Roose', 'Andrew Ng')

university <- c('Erik Brynjolfsson', 'Austan Goolsbee', 'Ethan Mollick',
                'Anton Korinek', 'Andrew Ng')

if(USE_API) {
  # Process the API data
  d0 <- qual_data |>
    filter(!is.na(`choice-3`), !is.na(PROLIFIC_PID), Finished==1) |>
    mutate(
      # Treatment assignment (control vs treatment)
      treatment = case_when(cond == "treatment" ~ 1, TRUE ~ 0),

      # Base rate assignment (low 20% vs high 80%)
      base_rate_high = case_when(base_rate == "high" ~ 1, TRUE ~ 0),

      # Feedback detection (embedded data variables from Qualtrics)
      women_feedback = as.numeric(feedback_women),
      age_feedback = as.numeric(feedback_age),
      location_feedback = as.numeric(feedback_location),
      university_feedback = as.numeric(feedback_university),

      # Count women selected across all 3 choices
      women_choice1 = case_when(`choice-1` %in% women ~ 1, TRUE ~ 0),
      women_choice2 = case_when(`choice-2` %in% women ~ 1, TRUE ~ 0),
      women_choice3 = case_when(`choice-3` %in% women ~ 1, TRUE ~ 0),

      # Total women count and proportion (primary DV)
      women_count = women_choice1 + women_choice2 + women_choice3,
      women_proportion = women_count / 3,

      # Other attribute picks
      age_count = case_when(`choice-1` %in% under_50 ~ 1, TRUE ~ 0) +
                  case_when(`choice-2` %in% under_50 ~ 1, TRUE ~ 0) +
                  case_when(`choice-3` %in% under_50 ~ 1, TRUE ~ 0),
      age_proportion = age_count / 3,

      location_count = case_when(`choice-1` %in% west_coast ~ 1, TRUE ~ 0) +
                       case_when(`choice-2` %in% west_coast ~ 1, TRUE ~ 0) +
                       case_when(`choice-3` %in% west_coast ~ 1, TRUE ~ 0),
      location_proportion = location_count / 3,

      university_count = case_when(`choice-1` %in% university ~ 1, TRUE ~ 0) +
                         case_when(`choice-2` %in% university ~ 1, TRUE ~ 0) +
                         case_when(`choice-3` %in% university ~ 1, TRUE ~ 0),
      university_proportion = university_count / 3
    ) |>
    # Process motivation scales (I1-I3, E1-E4)
    mutate(
      across(c(I1, I2, I3, E1, E2, E3, E4),
             ~ case_when(
               . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
               . == "Neither agree nor disagree" ~ 4,
               . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
               TRUE ~ NA_integer_))) |>
    # Process fairness scale (fair1-fair3)
    mutate(
      across(c(fair1, fair2, fair3),
             ~ case_when(
               . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
               . == "Neither agree nor disagree" ~ 4,
               . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
               TRUE ~ NA_integer_))) |>
    mutate(
      # Internal motivation scale (I1-I3) - standardized
      I1Z = (I1 - mean(I1, na.rm = TRUE)) / sd(I1, na.rm = TRUE),
      I2Z = (I2 - mean(I2, na.rm = TRUE)) / sd(I2, na.rm = TRUE),
      I3Z = (I3 - mean(I3, na.rm = TRUE)) / sd(I3, na.rm = TRUE),
      internal_motiv = (I1Z + I2Z + I3Z) / 3,

      # External motivation scale (E1-E4) - standardized
      E1Z = (E1 - mean(E1, na.rm = TRUE)) / sd(E1, na.rm = TRUE),
      E2Z = (E2 - mean(E2, na.rm = TRUE)) / sd(E2, na.rm = TRUE),
      E3Z = (E3 - mean(E3, na.rm = TRUE)) / sd(E3, na.rm = TRUE),
      E4Z = (E4 - mean(E4, na.rm = TRUE)) / sd(E4, na.rm = TRUE),
      external_motiv = (E1Z + E2Z + E3Z + E4Z) / 4,

      # Fairness scale (fair1-fair3) - standardized
      fair1Z = (fair1 - mean(fair1, na.rm = TRUE)) / sd(fair1, na.rm = TRUE),
      fair2Z = (fair2 - mean(fair2, na.rm = TRUE)) / sd(fair2, na.rm = TRUE),
      fair3Z = (fair3 - mean(fair3, na.rm = TRUE)) / sd(fair3, na.rm = TRUE),
      fairness = (fair1Z + fair2Z + fair3Z) / 3
    ) |>
    dplyr::select(treatment, base_rate_high, cond, base_rate,
                  women_feedback, age_feedback, location_feedback, university_feedback,
                  women_count, women_proportion, age_count, age_proportion,
                  location_count, location_proportion, university_count, university_proportion,
                  `choice-1`:`choice-3`, race, gender, age,
                  I1, I2, I3, E1, E2, E3, E4,
                  I1Z, I2Z, I3Z, E1Z, E2Z, E3Z, E4Z,
                  internal_motiv, external_motiv,
                  fair1, fair2, fair3, fair1Z, fair2Z, fair3Z, fairness)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'Study-4-pilot.csv', row.names = FALSE, quote = TRUE)
}
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{treatment} & Binary indicator of whether a participant was randomly assigned to treatment condition (shown women feedback). \\
\hline
\texttt{base\_rate\_high} & Binary indicator of base rate condition (1 = high/80\% women, 0 = low/20\% women). \\
\hline
\texttt{women\_feedback} & Binary indicator of whether women feedback was shown to participant. \\
\hline
\texttt{women\_count} & Count of women selected across the three choices (0-3). \\
\hline
\texttt{women\_proportion} & Proportion of women selected (DV: ranges from 0 to 1). \\
\hline
\texttt{age\_feedback} & Binary indicator of whether age feedback was shown. \\
\hline
\texttt{age\_proportion} & Proportion of experts under 50 years old selected. \\
\hline
\texttt{location\_feedback} & Binary indicator of whether location feedback was shown. \\
\hline
\texttt{location\_proportion} & Proportion of experts based on West Coast selected. \\
\hline
\texttt{university\_feedback} & Binary indicator of whether university feedback was shown. \\
\hline
\texttt{university\_proportion} & Proportion of experts working at a university selected. \\
\hline
\texttt{choice-1 to choice-3} & The selected AI experts \\
\hline
\texttt{internal\_motiv} & Aggregated Internal Motivation scale (mean of I1Z-I3Z). \\
\hline
\texttt{external\_motiv} & Aggregated External Motivation scale (mean of E1Z-E4Z). \\
\hline
\texttt{fairness} & Aggregated Fairness scale (mean of fair1Z-fair3Z). \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\end{tabular}
\end{table}

\newpage

## Demographics

```{r echo=FALSE, results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n\n')

## Sample size
cat('Total N:', nrow(d0), '\n\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)


## Race

race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

# Create the final data frame
race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

# Reorder the columns
colnames(race_df) <- c("Percentage", "Race")

# Print the data frame
print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Cell sizes

cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(base_rate, cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)

## Overall proportion of women selected

cat('\n\nMean proportion of women selected: ', round(mean(d0$women_proportion), 3), '\n')
cat('SD proportion of women selected: ', round(sd(d0$women_proportion), 3), '\n\n')

d0 |>
  dplyr::select(women_proportion, cond, base_rate) |>
  dplyr::group_by(cond, base_rate) |>
  dplyr::summarize(mean = mean(women_proportion), sd = sd(women_proportion), n = n(), .groups = "drop")
```

\newpage

## Cronbach's Alpha

```{r cronbach-alpha, echo=FALSE, results='markup'}
# Calculating Cronbach's Alpha for the scales

# Internal Motivation (I1-I3)
internal_items <- d0[, c("I1Z", "I2Z", "I3Z")]
alpha_internal <- alpha(internal_items)
cat("Cronbach's Alpha for Internal Motivation Scale: ", alpha_internal$total$raw_alpha, "\n\n")

# External Motivation (E1-E4)
external_items <- d0[, c("E1Z", "E2Z", "E3Z", "E4Z")]
alpha_external <- alpha(external_items)
cat("Cronbach's Alpha for External Motivation Scale: ", alpha_external$total$raw_alpha, "\n\n")

# Fairness (fair1-fair3)
fairness_items <- d0[, c("fair1Z", "fair2Z", "fair3Z")]
alpha_fairness <- alpha(fairness_items)
cat("Cronbach's Alpha for Fairness Scale: ", alpha_fairness$total$raw_alpha, "\n\n")
```

\newpage

## Primary Analysis: 2x2 Factorial ANOVA

```{r primary-analysis, echo=FALSE, results='markup'}
# 2x2 ANOVA: Treatment × Base Rate
model_2x2 <- lm(women_proportion ~ treatment * base_rate_high, data = d0)

cat("=== 2x2 FACTORIAL ANOVA ===\n")
cat("Model: women_proportion ~ treatment * base_rate_high\n\n")
robust_summary(model_2x2)
robust_confint(model_2x2)

# Cell means
cat("\n\nCell Means:\n")
d0 |>
  group_by(cond, base_rate) |>
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Simple Effects by Base Rate

### Low Base Rate (20% Women)

```{r low-base-rate, echo=FALSE, results='markup'}
# Low base rate model: main effect of treatment
model_low <- lm(women_proportion ~ treatment,
                data = d0 %>% filter(base_rate_high == 0))

cat("=== LOW BASE RATE (20% WOMEN) ===\n")
cat("Model: women_proportion ~ treatment\n\n")
robust_summary(model_low)
robust_confint(model_low)

# Cell means
cat("\n\nCell Means - Low Base Rate:\n")
d0 %>%
  filter(base_rate_high == 0) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### High Base Rate (80% Women)

```{r high-base-rate, echo=FALSE, results='markup'}
# High base rate model: main effect of treatment
model_high <- lm(women_proportion ~ treatment,
                 data = d0 %>% filter(base_rate_high == 1))

cat("=== HIGH BASE RATE (80% WOMEN) ===\n")
cat("Model: women_proportion ~ treatment\n\n")
robust_summary(model_high)
robust_confint(model_high)

# Cell means
cat("\n\nCell Means - High Base Rate:\n")
d0 %>%
  filter(base_rate_high == 1) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Wald Test: Comparing Treatment Effects Across Base Rates

```{r wald-test, echo=FALSE, results='markup'}
cat("=== WALD TEST: DIFFERENCE IN TREATMENT EFFECTS BETWEEN BASE RATES ===\n\n")

# Calculate treatment effects for each base rate
# Low base rate: just the treatment coefficient
effect_low <- coef(model_low)["treatment"]
se_low <- sqrt(diag(vcovHC(model_low, type = "HC3")))["treatment"]

# High base rate: just the treatment coefficient
effect_high <- coef(model_high)["treatment"]
se_high <- sqrt(diag(vcovHC(model_high, type = "HC3")))["treatment"]

# Calculate difference in treatment effects
diff_effects <- effect_low - effect_high

# Standard error of the difference (assuming independence)
se_diff <- sqrt(se_low^2 + se_high^2)

# Wald test statistic
wald_stat <- diff_effects / se_diff

# P-value (two-tailed)
p_value <- 2 * (1 - pnorm(abs(wald_stat)))

# 95% CI for the difference
ci_lower <- diff_effects - 1.96 * se_diff
ci_upper <- diff_effects + 1.96 * se_diff

# Print results
cat("Treatment Effect (Low Base Rate 20%):  ", sprintf("%.4f", effect_low),
    " (SE = ", sprintf("%.4f", se_low), ")\n", sep = "")
cat("Treatment Effect (High Base Rate 80%): ", sprintf("%.4f", effect_high),
    " (SE = ", sprintf("%.4f", se_high), ")\n\n", sep = "")

cat("Difference in Treatment Effects: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("Standard Error of Difference:    ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Wald Statistic (z):              ", sprintf("%.4f", wald_stat), "\n", sep = "")
cat("P-value (two-tailed):            ", sprintf("%.4f", p_value), "\n", sep = "")
cat("95% CI for Difference:           [", sprintf("%.4f", ci_lower), ", ",
    sprintf("%.4f", ci_upper), "]\n\n", sep = "")

if (p_value < 0.001) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between base rates (p < 0.001).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else if (p_value < 0.01) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between base rates (p < 0.01).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else if (p_value < 0.05) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between base rates (p < 0.05).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else {
  cat("INTERPRETATION: The treatment effect does NOT significantly differ between base rates (p >= 0.05).\n")
}

cat("\nNote: This Wald test formally tests whether the treatment effect at low base rate\n")
cat("is significantly different from the treatment effect at high base rate.\n")
cat("The test uses robust (HC3) standard errors.\n")
```

\newpage

# Visualization

## Interaction Plot: Treatment × Base Rate

```{r fig-interaction, fig.cap="Effect of Gender Feedback by Base Rate Condition", fig.width=10, fig.height=8, echo=FALSE}
# Run statistical tests to determine significance levels
test_low <- t.test(women_proportion ~ treatment, data=d0 %>% filter(base_rate_high == 0))
test_high <- t.test(women_proportion ~ treatment, data=d0 %>% filter(base_rate_high == 1))

# Function to get significance stars
get_sig_stars <- function(p_value) {
  if (p_value < 0.001) return("***")
  else if (p_value < 0.01) return("**")
  else if (p_value < 0.05) return("*")
  else return("n.s.")
}

sig_low <- get_sig_stars(test_low$p.value)
sig_high <- get_sig_stars(test_high$p.value)

# Prepare plot data for low base rate (20% women)
dlow_plot <- d0 %>%
  filter(base_rate_high == 0) %>%
  dplyr::select(treatment, women_proportion) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(women_proportion),
    sd = sd(women_proportion) * 100,
    se = (sd(women_proportion) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Prepare plot data for high base rate (80% women)
dhigh_plot <- d0 %>%
  filter(base_rate_high == 1) %>%
  dplyr::select(treatment, women_proportion) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(women_proportion),
    sd = sd(women_proportion) * 100,
    se = (sd(women_proportion) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Combine into single dataframe
df_combined <- bind_rows(
  dlow_plot %>% mutate(Category = "Low Base Rate\n(20% Women)"),
  dhigh_plot %>% mutate(Category = "High Base Rate\n(80% Women)")
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('Low Base Rate\n(20% Women)', 'High Base Rate\n(80% Women)')))

# Create combined plot
p_combined <- ggplot(df_combined, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 7, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~Category, nrow = 1, strip.position = "bottom") +
  geom_segment(data = df_combined %>% filter(Category == "Low Base Rate\n(20% Women)" & Condition == "Treatment"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_segment(data = df_combined %>% filter(Category == "High Base Rate\n(80% Women)" & Condition == "Control"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_text(data = df_combined %>% filter(Category == "Low Base Rate\n(20% Women)" & Condition == "Treatment"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_low),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  geom_text(data = df_combined %>% filter(Category == "High Base Rate\n(80% Women)" & Condition == "Control"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_high),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  theme_bw() +
  scale_fill_manual(values = c("#990000", "#011F5B"), labels = c("No gender feedback provided", "Gender feedback provided"), "") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("Control" = "Not\nShown", "Treatment" = "Shown")) +
  labs(x = "", y = "% of Women Selected") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.direction = "horizontal",
        legend.text = element_text(size = 18),
        legend.key.size = unit(5, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = 18, color = "black"),
        plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 18, color = "black"),
        strip.text = element_text(size = 18, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

# Display the plot
print(p_combined)

# Save the plot
ggsave("Study-4-pilot-figure.pdf", plot = p_combined, width = 10, height = 8, units = "in", device = cairo_pdf)
```

\newpage

# Conditional Mediation Analyses

## Mediation in Low Base Rate (20% Women)

```{r mediation-low-base, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

# Define function for Sobel Test
sobel_test <- function(med.fit, out.fit, mediator) {
  med.se <- sqrt(diag(vcovHC(med.fit)))[mediator]
  out.se <- sqrt(diag(vcovHC(out.fit)))[mediator]
  sobel_test_statistic <- coef(out.fit)[mediator] / sqrt(vcovHC(out.fit)[mediator, mediator])
  sobel_p_value <- 2 * (1 - pnorm(abs(sobel_test_statistic)))
  list(statistic = sobel_test_statistic, p_value = sobel_p_value, se = out.se)
}

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: LOW BASE RATE (20% WOMEN)\n")
cat("=======================================================\n\n")

# Filter data for low base rate only
d_low <- d0 %>% filter(base_rate_high == 0)

# -----------------------------
# Internal Motivation - Low Base Rate
# -----------------------------

cat("--- INTERNAL MOTIVATION - LOW BASE RATE ---\n\n")

# Mediator model
med.fit.internal.low <- lm(internal_motiv ~ treatment, data = d_low)
summary(med.fit.internal.low)

# Outcome model including mediator
out.fit.internal.low <- lm(women_proportion ~ treatment + internal_motiv, data = d_low)

# Mediation analysis
med.out.internal.low <- mediate(med.fit.internal.low, out.fit.internal.low, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "internal_motiv", sims = 10000)

# Sobel test
sobel.internal.low <- sobel_test(med.fit.internal.low, out.fit.internal.low, "internal_motiv")

cat("Sobel test for Internal Motivation (Low Base Rate):\n")
print(sobel.internal.low)
cat("\n")
summary(med.out.internal.low)

cat("\n\n")

# -----------------------------
# External Motivation - Low Base Rate
# -----------------------------

cat("--- EXTERNAL MOTIVATION - LOW BASE RATE ---\n\n")

# Mediator model
med.fit.external.low <- lm(external_motiv ~ treatment, data = d_low)
summary(med.fit.external.low)

# Outcome model including mediator
out.fit.external.low <- lm(women_proportion ~ treatment + external_motiv, data = d_low)

# Mediation analysis
med.out.external.low <- mediate(med.fit.external.low, out.fit.external.low, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "external_motiv", sims = 10000)

# Sobel test
sobel.external.low <- sobel_test(med.fit.external.low, out.fit.external.low, "external_motiv")

cat("Sobel test for External Motivation (Low Base Rate):\n")
print(sobel.external.low)
cat("\n")
summary(med.out.external.low)

cat("\n\n")

# -----------------------------
# Fairness - Low Base Rate
# -----------------------------

cat("--- FAIRNESS SCALE - LOW BASE RATE ---\n\n")

# Mediator model
med.fit.fairness.low <- lm(fairness ~ treatment, data = d_low)
summary(med.fit.fairness.low)

# Outcome model including mediator
out.fit.fairness.low <- lm(women_proportion ~ treatment + fairness, data = d_low)

# Mediation analysis
med.out.fairness.low <- mediate(med.fit.fairness.low, out.fit.fairness.low, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.low <- sobel_test(med.fit.fairness.low, out.fit.fairness.low, "fairness")

cat("Sobel test for Fairness (Low Base Rate):\n")
print(sobel.fairness.low)
cat("\n")
summary(med.out.fairness.low)
```

\newpage

## Mediation in High Base Rate (80% Women)

```{r mediation-high-base, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: HIGH BASE RATE (80% WOMEN)\n")
cat("=======================================================\n\n")

# Filter data for high base rate only
d_high <- d0 %>% filter(base_rate_high == 1)

# -----------------------------
# Internal Motivation - High Base Rate
# -----------------------------

cat("--- INTERNAL MOTIVATION - HIGH BASE RATE ---\n\n")

# Mediator model
med.fit.internal.high <- lm(internal_motiv ~ treatment, data = d_high)
summary(med.fit.internal.high)

# Outcome model including mediator
out.fit.internal.high <- lm(women_proportion ~ treatment + internal_motiv, data = d_high)

# Mediation analysis
med.out.internal.high <- mediate(med.fit.internal.high, out.fit.internal.high, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "internal_motiv", sims = 10000)

# Sobel test
sobel.internal.high <- sobel_test(med.fit.internal.high, out.fit.internal.high, "internal_motiv")

cat("Sobel test for Internal Motivation (High Base Rate):\n")
print(sobel.internal.high)
cat("\n")
summary(med.out.internal.high)

cat("\n\n")

# -----------------------------
# External Motivation - High Base Rate
# -----------------------------

cat("--- EXTERNAL MOTIVATION - HIGH BASE RATE ---\n\n")

# Mediator model
med.fit.external.high <- lm(external_motiv ~ treatment, data = d_high)
summary(med.fit.external.high)

# Outcome model including mediator
out.fit.external.high <- lm(women_proportion ~ treatment + external_motiv, data = d_high)

# Mediation analysis
med.out.external.high <- mediate(med.fit.external.high, out.fit.external.high, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "external_motiv", sims = 10000)

# Sobel test
sobel.external.high <- sobel_test(med.fit.external.high, out.fit.external.high, "external_motiv")

cat("Sobel test for External Motivation (High Base Rate):\n")
print(sobel.external.high)
cat("\n")
summary(med.out.external.high)

cat("\n\n")

# -----------------------------
# Fairness - High Base Rate
# -----------------------------

cat("--- FAIRNESS SCALE - HIGH BASE RATE ---\n\n")

# Mediator model
med.fit.fairness.high <- lm(fairness ~ treatment, data = d_high)
summary(med.fit.fairness.high)

# Outcome model including mediator
out.fit.fairness.high <- lm(women_proportion ~ treatment + fairness, data = d_high)

# Mediation analysis
med.out.fairness.high <- mediate(med.fit.fairness.high, out.fit.fairness.high, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.high <- sobel_test(med.fit.fairness.high, out.fit.fairness.high, "fairness")

cat("Sobel test for Fairness (High Base Rate):\n")
print(sobel.fairness.high)
cat("\n")
summary(med.out.fairness.high)
```

\newpage
