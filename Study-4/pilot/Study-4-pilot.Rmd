---
title: "Study 4 Pilot"
subtitle: "2x2 Pool (Women vs Men) × Feedback (Control vs Treatment)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
library(mediation)
library(boot)
```

```{r include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)

if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```



```{r include=FALSE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- TRUE

if(USE_API) {
  ## Pull directly from Qualtrics API
  qual_data <- fetch_survey(surveyID='SV_eysJmstT7Zxvd2K',
                     label = T,
                     convert = F,
                     start_date = "2025-11-18",
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('Study-4-pilot.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define the categories based on the CEO/Founder stimuli
women <- c("Whitney Wolfe Herd (Founder of Bumble)",
           "Leah Busque (Founder of TaskRabbit)",
           "Melanie Perkins (Founder of Canva)",
           "Julia Hartz (Co-founder of EventBrite)",
           "Arianna Huffington (Co-founder of Huffington Post)",
           "Anne Wojcicki (CEO of 23andMe)",
           "Corie Barry (CEO of Best Buy)",
           "Safra Katz (CEO of Oracle)",
           "Mary Barra (CEO of General Motors)",
           "Tory Burch (Founder of Tory Burch)",
           "Sara Blakely (Founder of Spanx)",
           "Oprah Winfrey (Founder of OWN)",
           "Bobbi Brown (Founder of Bobbi Brown Cosmetics)",
           "Jane Fraser (CEO of Citigroup)",
           "Rosalind Brewer (CEO of Walgreens)",
           "Karen Lynch (CEO of CVS Health)",
           "Carol Tomé (CEO of UPS)",
           "Indra Nooyi (Former CEO of PepsiCo)")

men <- c("Larry Page (Co-founder of Google)",
         "Mark Zuckerberg (Co-founder of Facebook)",
         "Bill Gates (Co-founder of Microsoft)",
         "Jeff Bezos (Founder of Amazon)",
         "Tim Cook (CEO of Apple)",
         "Sundar Pichai (CEO of Alphabet Inc.)",
         "Satya Nadella (CEO of Microsoft)",
         "Jensen Huang (CEO of NVIDIA)",
         "Andy Jassy (CEO of Amazon)",
         "Daymond John (Founder of FUBU)",
         "Phil Knight (Co-founder of Nike)",
         "Howard Schultz (Founder of Starbucks)",
         "Michael Bloomberg (Co-founder of Bloomberg LP)",
         "Richard Branson (Founder of Virgin Group)",
         "Warren Buffett (CEO of Berkshire Hathaway)",
         "Jamie Dimon (CEO of JPMorgan Chase)",
         "Brian Moynihan (CEO of Bank of America)",
         "Lloyd Blankfein (Former CEO of Goldman Sachs)")

technologists <- c("Whitney Wolfe Herd", "Leah Busque", "Melanie Perkins",
                   "Julia Hartz", "Arianna Huffington",
                   "Anne Wojcicki", "Corie Barry", "Safra Katz", "Mary Barra",
                   "Larry Page", "Mark Zuckerberg", "Bill Gates", "Jeff Bezos",
                   "Tim Cook", "Sundar Pichai", "Satya Nadella", "Jensen Huang", "Andy Jassy")

if(USE_API) {
  # Process the API data
  d0 <- qual_data |>
    filter(!is.na(`choice-6`), !is.na(PROLIFIC_PID), Finished==1) |>
    mutate(
      # Treatment assignment (control vs treatment)
      treatment = case_when(cond == "treat" ~ 1, TRUE ~ 0),

      # Pool assignment (women vs men pool)
      women_pool = case_when(pool == "women" ~ 1, TRUE ~ 0),

      # Count women selected across all 6 choices
      women_choice1 = case_when(`choice-1` %in% women ~ 1, TRUE ~ 0),
      women_choice2 = case_when(`choice-2` %in% women ~ 1, TRUE ~ 0),
      women_choice3 = case_when(`choice-3` %in% women ~ 1, TRUE ~ 0),
      women_choice4 = case_when(`choice-4` %in% women ~ 1, TRUE ~ 0),
      women_choice5 = case_when(`choice-5` %in% women ~ 1, TRUE ~ 0),
      women_choice6 = case_when(`choice-6` %in% women ~ 1, TRUE ~ 0),

      # Total women count and proportion (primary DV)
      women_count = women_choice1 + women_choice2 + women_choice3 +
                    women_choice4 + women_choice5 + women_choice6,
      women_proportion = women_count / 6,

      # Count technologists selected
      tech_count = case_when(`choice-1` %in% technologists ~ 1, TRUE ~ 0) +
                   case_when(`choice-2` %in% technologists ~ 1, TRUE ~ 0) +
                   case_when(`choice-3` %in% technologists ~ 1, TRUE ~ 0) +
                   case_when(`choice-4` %in% technologists ~ 1, TRUE ~ 0) +
                   case_when(`choice-5` %in% technologists ~ 1, TRUE ~ 0) +
                   case_when(`choice-6` %in% technologists ~ 1, TRUE ~ 0),
      tech_proportion = tech_count / 6
    ) |>
    # Process motivation scales (I1-I4 for internal, E1-E3 for external)
    mutate(
      across(c(I1, I2, I3, I4, E1, E2, E3),
             ~ case_when(
               . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
               . == "Neither agree nor disagree" ~ 4,
               . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
               TRUE ~ NA_integer_))) |>
    # Process fairness scale (fair1-fair3)
    mutate(
      across(c(fair1, fair2, fair3),
             ~ case_when(
               . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
               . == "Neither agree nor disagree" ~ 4,
               . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
               TRUE ~ NA_integer_))) |>
    mutate(
      # Internal motivation scale (I1-I4) - standardized
      I1Z = (I1 - mean(I1, na.rm = TRUE)) / sd(I1, na.rm = TRUE),
      I2Z = (I2 - mean(I2, na.rm = TRUE)) / sd(I2, na.rm = TRUE),
      I3Z = (I3 - mean(I3, na.rm = TRUE)) / sd(I3, na.rm = TRUE),
      I4Z = (I4 - mean(I4, na.rm = TRUE)) / sd(I4, na.rm = TRUE),
      internal_motiv = (I1Z + I2Z + I3Z + I4Z) / 4,

      # External motivation scale (E1-E3) - standardized
      E1Z = (E1 - mean(E1, na.rm = TRUE)) / sd(E1, na.rm = TRUE),
      E2Z = (E2 - mean(E2, na.rm = TRUE)) / sd(E2, na.rm = TRUE),
      E3Z = (E3 - mean(E3, na.rm = TRUE)) / sd(E3, na.rm = TRUE),
      external_motiv = (E1Z + E2Z + E3Z) / 3,

      # Fairness scale (fair1-fair3) - standardized
      fair1Z = (fair1 - mean(fair1, na.rm = TRUE)) / sd(fair1, na.rm = TRUE),
      fair2Z = (fair2 - mean(fair2, na.rm = TRUE)) / sd(fair2, na.rm = TRUE),
      fair3Z = (fair3 - mean(fair3, na.rm = TRUE)) / sd(fair3, na.rm = TRUE),
      fairness = (fair1Z + fair2Z + fair3Z) / 3
    ) |>
    dplyr::select(treatment, women_pool, cond, pool,
                  women_count, women_proportion, tech_count, tech_proportion,
                  `choice-1`:`choice-6`, race, gender, age,
                  I1, I2, I3, I4, E1, E2, E3,
                  I1Z, I2Z, I3Z, I4Z, E1Z, E2Z, E3Z,
                  internal_motiv, external_motiv,
                  fair1, fair2, fair3, fair1Z, fair2Z, fair3Z, fairness)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'Study-4-pilot.csv', row.names = FALSE, quote = TRUE)
}
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{treatment} & Binary indicator of whether a participant was randomly assigned to treatment condition (1 = treat, 0 = control). \\
\hline
\texttt{women\_pool} & Binary indicator of pool condition (1 = women pool/75\% women, 0 = men pool/25\% women). \\
\hline
\texttt{women\_count} & Count of women selected across the six choices (0-6). \\
\hline
\texttt{women\_proportion} & Proportion of women selected (DV: ranges from 0 to 1). \\
\hline
\texttt{tech\_count} & Count of technologists selected across the six choices (0-6). \\
\hline
\texttt{tech\_proportion} & Proportion of technologists selected. \\
\hline
\texttt{choice-1 to choice-6} & The selected CEOs/Founders \\
\hline
\texttt{internal\_motiv} & Aggregated Internal Motivation scale (mean of I1Z-I4Z). \\
\hline
\texttt{external\_motiv} & Aggregated External Motivation scale (mean of E1Z-E3Z). \\
\hline
\texttt{fairness} & Aggregated Fairness scale (mean of fair1Z-fair3Z). \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\end{tabular}
\end{table}

\newpage

## Demographics

```{r echo=FALSE, results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n\n')

## Sample size
cat('Total N:', nrow(d0), '\n\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)


## Race

race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

# Create the final data frame
race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

# Reorder the columns
colnames(race_df) <- c("Percentage", "Race")

# Print the data frame
print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Cell sizes

cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(pool, cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)

## Overall proportion of women selected

cat('\n\nMean proportion of women selected: ', round(mean(d0$women_proportion), 3), '\n')
cat('SD proportion of women selected: ', round(sd(d0$women_proportion), 3), '\n\n')

d0 |>
  dplyr::select(women_proportion, cond, pool) |>
  dplyr::group_by(cond, pool) |>
  dplyr::summarize(mean = mean(women_proportion), sd = sd(women_proportion), n = n(), .groups = "drop")
```

\newpage

## Cronbach's Alpha

```{r cronbach-alpha, echo=FALSE, results='markup'}
# Calculating Cronbach's Alpha for the scales

# Internal Motivation (I1-I4)
internal_items <- d0[, c("I1Z", "I2Z", "I3Z", "I4Z")]
alpha_internal <- alpha(internal_items)
cat("Cronbach's Alpha for Internal Motivation Scale: ", alpha_internal$total$raw_alpha, "\n\n")

# External Motivation (E1-E3)
external_items <- d0[, c("E1Z", "E2Z", "E3Z")]
alpha_external <- alpha(external_items)
cat("Cronbach's Alpha for External Motivation Scale: ", alpha_external$total$raw_alpha, "\n\n")

# Fairness (fair1-fair3)
fairness_items <- d0[, c("fair1Z", "fair2Z", "fair3Z")]
alpha_fairness <- alpha(fairness_items)
cat("Cronbach's Alpha for Fairness Scale: ", alpha_fairness$total$raw_alpha, "\n\n")
```

\newpage

## Primary Analysis: 2x2 Factorial ANOVA

```{r primary-analysis, echo=FALSE, results='markup'}
# 2x2 ANOVA: Treatment × Pool
model_2x2 <- lm(women_proportion ~ treatment * women_pool, data = d0)

cat("=== 2x2 FACTORIAL ANOVA ===\n")
cat("Model: women_proportion ~ treatment * women_pool\n\n")
robust_summary(model_2x2)
robust_confint(model_2x2)

# Cell means
cat("\n\nCell Means:\n")
d0 |>
  group_by(cond, pool) |>
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Simple Effects by Pool

### Men Pool (25% Women)

```{r men-pool, echo=FALSE, results='markup'}
# Men pool model: main effect of treatment
model_men <- lm(women_proportion ~ treatment,
                data = d0 %>% filter(women_pool == 0))

cat("=== MEN POOL (25% WOMEN) ===\n")
cat("Model: women_proportion ~ treatment\n\n")
robust_summary(model_men)
robust_confint(model_men)

# Cell means
cat("\n\nCell Means - Men Pool:\n")
d0 %>%
  filter(women_pool == 0) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### Women Pool (75% Women)

```{r women-pool, echo=FALSE, results='markup'}
# Women pool model: main effect of treatment
model_women <- lm(women_proportion ~ treatment,
                 data = d0 %>% filter(women_pool == 1))

cat("=== WOMEN POOL (75% WOMEN) ===\n")
cat("Model: women_proportion ~ treatment\n\n")
robust_summary(model_women)
robust_confint(model_women)

# Cell means
cat("\n\nCell Means - Women Pool:\n")
d0 %>%
  filter(women_pool == 1) %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_women_prop = mean(women_proportion) * 100,
    se = sd(women_proportion) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

## Wald Test: Comparing Treatment Effects Across Pools

```{r wald-test, echo=FALSE, results='markup'}
cat("=== WALD TEST: DIFFERENCE IN TREATMENT EFFECTS BETWEEN POOLS ===\n\n")

# Calculate treatment effects for each pool
# Men pool: just the treatment coefficient
effect_men <- coef(model_men)["treatment"]
se_men <- sqrt(diag(vcovHC(model_men, type = "HC3")))["treatment"]

# Women pool: just the treatment coefficient
effect_women <- coef(model_women)["treatment"]
se_women <- sqrt(diag(vcovHC(model_women, type = "HC3")))["treatment"]

# Calculate difference in treatment effects
diff_effects <- effect_men - effect_women

# Standard error of the difference (assuming independence)
se_diff <- sqrt(se_men^2 + se_women^2)

# Wald test statistic
wald_stat <- diff_effects / se_diff

# P-value (two-tailed)
p_value <- 2 * (1 - pnorm(abs(wald_stat)))

# 95% CI for the difference
ci_lower <- diff_effects - 1.96 * se_diff
ci_upper <- diff_effects + 1.96 * se_diff

# Print results
cat("Treatment Effect (Men Pool 25%):   ", sprintf("%.4f", effect_men),
    " (SE = ", sprintf("%.4f", se_men), ")\n", sep = "")
cat("Treatment Effect (Women Pool 75%): ", sprintf("%.4f", effect_women),
    " (SE = ", sprintf("%.4f", se_women), ")\n\n", sep = "")

cat("Difference in Treatment Effects: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("Standard Error of Difference:    ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Wald Statistic (z):              ", sprintf("%.4f", wald_stat), "\n", sep = "")
cat("P-value (two-tailed):            ", sprintf("%.4f", p_value), "\n", sep = "")
cat("95% CI for Difference:           [", sprintf("%.4f", ci_lower), ", ",
    sprintf("%.4f", ci_upper), "]\n\n", sep = "")

if (p_value < 0.001) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.001).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else if (p_value < 0.01) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.01).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else if (p_value < 0.05) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.05).\n")
  cat("This supports the reversal hypothesis: gender feedback has opposite effects\n")
  cat("depending on whether women are under- or over-represented.\n")
} else {
  cat("INTERPRETATION: The treatment effect does NOT significantly differ between pools (p >= 0.05).\n")
}

cat("\nNote: This Wald test formally tests whether the treatment effect at men pool\n")
cat("is significantly different from the treatment effect at women pool.\n")
cat("The test uses robust (HC3) standard errors.\n")
```

\newpage

# Visualization

## Interaction Plot: Treatment × Pool

```{r fig-interaction, fig.cap="Effect of Gender Feedback by Pool Condition", fig.width=10, fig.height=8, echo=FALSE}
# Run statistical tests to determine significance levels
test_men <- t.test(women_proportion ~ treatment, data=d0 %>% filter(women_pool == 0))
test_women <- t.test(women_proportion ~ treatment, data=d0 %>% filter(women_pool == 1))

# Function to get significance stars
get_sig_stars <- function(p_value) {
  if (p_value < 0.001) return("***")
  else if (p_value < 0.01) return("**")
  else if (p_value < 0.05) return("*")
  else return("n.s.")
}

sig_men <- get_sig_stars(test_men$p.value)
sig_women <- get_sig_stars(test_women$p.value)

# Prepare plot data for men pool (25% women)
dmen_plot <- d0 %>%
  filter(women_pool == 0) %>%
  dplyr::select(treatment, women_proportion) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(women_proportion),
    sd = sd(women_proportion) * 100,
    se = (sd(women_proportion) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Prepare plot data for women pool (75% women)
dwomen_plot <- d0 %>%
  filter(women_pool == 1) %>%
  dplyr::select(treatment, women_proportion) %>%
  group_by(treatment) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(women_proportion),
    sd = sd(women_proportion) * 100,
    se = (sd(women_proportion) / sqrt(n())) * 100
  ) %>%
  mutate(treatment = case_when(treatment==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = treatment)

# Combine into single dataframe
df_combined <- bind_rows(
  dmen_plot %>% mutate(Category = "Women Underrepresented\n(Men Pool)"),
  dwomen_plot %>% mutate(Category = "Women Overrepresented\n(Women Pool)")
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('Women Underrepresented\n(Men Pool)', 'Women Overrepresented\n(Women Pool)')))

# Create combined plot
p_combined <- ggplot(df_combined, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 7, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~Category, nrow = 1, strip.position = "bottom") +
  geom_segment(data = df_combined %>% filter(Category == "Women Underrepresented\n(Men Pool)" & Condition == "Treatment"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_segment(data = df_combined %>% filter(Category == "Women Overrepresented\n(Women Pool)" & Condition == "Control"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_text(data = df_combined %>% filter(Category == "Women Underrepresented\n(Men Pool)" & Condition == "Treatment"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_men),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  geom_text(data = df_combined %>% filter(Category == "Women Overrepresented\n(Women Pool)" & Condition == "Control"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_women),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  theme_bw() +
  scale_fill_manual(values = c("#990000", "#011F5B"), labels = c("No gender feedback provided", "Gender feedback provided"), "") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("Control" = "Not\nShown", "Treatment" = "Shown")) +
  labs(x = "", y = "% of Women Selected") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.direction = "horizontal",
        legend.text = element_text(size = 18),
        legend.key.size = unit(5, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = 18, color = "black"),
        plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 18, color = "black"),
        strip.text = element_text(size = 18, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

# Display the plot
print(p_combined)

# Save the plot
ggsave("Study-4-pilot-figure.pdf", plot = p_combined, width = 10, height = 8, units = "in", device = cairo_pdf)
```

\newpage

# Conditional Mediation Analyses

## Mediation in Men Pool (Women Underrepresented)

```{r mediation-men-pool, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

# Define function for Sobel Test
sobel_test <- function(med.fit, out.fit, mediator) {
  med.se <- sqrt(diag(vcovHC(med.fit)))[mediator]
  out.se <- sqrt(diag(vcovHC(out.fit)))[mediator]
  sobel_test_statistic <- coef(out.fit)[mediator] / sqrt(vcovHC(out.fit)[mediator, mediator])
  sobel_p_value <- 2 * (1 - pnorm(abs(sobel_test_statistic)))
  list(statistic = sobel_test_statistic, p_value = sobel_p_value, se = out.se)
}

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: MEN POOL (WOMEN UNDERREPRESENTED)\n")
cat("=======================================================\n\n")

# Filter data for men pool only
d_men <- d0 %>% filter(women_pool == 0)

# -----------------------------
# Internal Motivation - Men Pool
# -----------------------------

cat("--- INTERNAL MOTIVATION - MEN POOL ---\n\n")

# Mediator model
med.fit.internal.men <- lm(internal_motiv ~ treatment, data = d_men)
summary(med.fit.internal.men)

# Outcome model including mediator
out.fit.internal.men <- lm(women_proportion ~ treatment + internal_motiv, data = d_men)

# Mediation analysis
med.out.internal.men <- mediate(med.fit.internal.men, out.fit.internal.men, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "internal_motiv", sims = 10000)

# Sobel test
sobel.internal.men <- sobel_test(med.fit.internal.men, out.fit.internal.men, "internal_motiv")

cat("Sobel test for Internal Motivation (Men Pool):\n")
print(sobel.internal.men)
cat("\n")
summary(med.out.internal.men)

cat("\n\n")

# -----------------------------
# External Motivation - Men Pool
# -----------------------------

cat("--- EXTERNAL MOTIVATION - MEN POOL ---\n\n")

# Mediator model
med.fit.external.men <- lm(external_motiv ~ treatment, data = d_men)
summary(med.fit.external.men)

# Outcome model including mediator
out.fit.external.men <- lm(women_proportion ~ treatment + external_motiv, data = d_men)

# Mediation analysis
med.out.external.men <- mediate(med.fit.external.men, out.fit.external.men, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "external_motiv", sims = 10000)

# Sobel test
sobel.external.men <- sobel_test(med.fit.external.men, out.fit.external.men, "external_motiv")

cat("Sobel test for External Motivation (Men Pool):\n")
print(sobel.external.men)
cat("\n")
summary(med.out.external.men)

cat("\n\n")

# -----------------------------
# Fairness - Men Pool
# -----------------------------

cat("--- FAIRNESS SCALE - MEN POOL ---\n\n")

# Mediator model
med.fit.fairness.men <- lm(fairness ~ treatment, data = d_men)
summary(med.fit.fairness.men)

# Outcome model including mediator
out.fit.fairness.men <- lm(women_proportion ~ treatment + fairness, data = d_men)

# Mediation analysis
med.out.fairness.men <- mediate(med.fit.fairness.men, out.fit.fairness.men, boot = TRUE,
                                treat = "treatment", boot.ci.type = "perc",
                                mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.men <- sobel_test(med.fit.fairness.men, out.fit.fairness.men, "fairness")

cat("Sobel test for Fairness (Men Pool):\n")
print(sobel.fairness.men)
cat("\n")
summary(med.out.fairness.men)
```

\newpage

## Mediation in Women Pool (Women Overrepresented)

```{r mediation-women-pool, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: WOMEN POOL (WOMEN OVERREPRESENTED)\n")
cat("=======================================================\n\n")

# Filter data for women pool only
d_women <- d0 %>% filter(women_pool == 1)

# -----------------------------
# Internal Motivation - Women Pool
# -----------------------------

cat("--- INTERNAL MOTIVATION - WOMEN POOL ---\n\n")

# Mediator model
med.fit.internal.women <- lm(internal_motiv ~ treatment, data = d_women)
summary(med.fit.internal.women)

# Outcome model including mediator
out.fit.internal.women <- lm(women_proportion ~ treatment + internal_motiv, data = d_women)

# Mediation analysis
med.out.internal.women <- mediate(med.fit.internal.women, out.fit.internal.women, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "internal_motiv", sims = 10000)

# Sobel test
sobel.internal.women <- sobel_test(med.fit.internal.women, out.fit.internal.women, "internal_motiv")

cat("Sobel test for Internal Motivation (Women Pool):\n")
print(sobel.internal.women)
cat("\n")
summary(med.out.internal.women)

cat("\n\n")

# -----------------------------
# External Motivation - Women Pool
# -----------------------------

cat("--- EXTERNAL MOTIVATION - WOMEN POOL ---\n\n")

# Mediator model
med.fit.external.women <- lm(external_motiv ~ treatment, data = d_women)
summary(med.fit.external.women)

# Outcome model including mediator
out.fit.external.women <- lm(women_proportion ~ treatment + external_motiv, data = d_women)

# Mediation analysis
med.out.external.women <- mediate(med.fit.external.women, out.fit.external.women, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "external_motiv", sims = 10000)

# Sobel test
sobel.external.women <- sobel_test(med.fit.external.women, out.fit.external.women, "external_motiv")

cat("Sobel test for External Motivation (Women Pool):\n")
print(sobel.external.women)
cat("\n")
summary(med.out.external.women)

cat("\n\n")

# -----------------------------
# Fairness - Women Pool
# -----------------------------

cat("--- FAIRNESS SCALE - WOMEN POOL ---\n\n")

# Mediator model
med.fit.fairness.women <- lm(fairness ~ treatment, data = d_women)
summary(med.fit.fairness.women)

# Outcome model including mediator
out.fit.fairness.women <- lm(women_proportion ~ treatment + fairness, data = d_women)

# Mediation analysis
med.out.fairness.women <- mediate(med.fit.fairness.women, out.fit.fairness.women, boot = TRUE,
                                 treat = "treatment", boot.ci.type = "perc",
                                 mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.women <- sobel_test(med.fit.fairness.women, out.fit.fairness.women, "fairness")

cat("Sobel test for Fairness (Women Pool):\n")
print(sobel.fairness.women)
cat("\n")
summary(med.out.fairness.women)
```

\newpage
