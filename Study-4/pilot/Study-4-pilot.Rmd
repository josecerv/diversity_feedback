---
title: "Study 4 Pilot"
subtitle: "2x2 Pool Composition (Men vs Women) × Feedback (Control vs Treatment)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
library(mediation)
```

```{r include=FALSE}
if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```



```{r include=FALSE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- TRUE

if(USE_API) {
  ## Pull directly from Qualtrics API (force_request = T gets latest data from today 11-14-2025)
  qual_data <- fetch_survey(surveyID='SV_eysJmstT7Zxvd2K',
                     label = T,
                     convert = F,
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('Study-4-pilot.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define all women leaders (from Study 4)
all_women <- c("Jane Fraser (CEO of Citigroup)", "Oprah Winfrey (CEO of Oprah Winfrey Network)",
               "Delphine Arnault (CEO of Christian Dior)", "Michelle Buck (CEO of The Hershey Company)",
               "Mary Barra (CEO of General Motors)", "Rosalind Brewer (CEO of Walgreens)",
               "Anne Wojcicki (CEO of 23andMe)", "Arianna Huffington (Co-founder of Huffington Post)",
               "Karen Lynch (CEO of CVS Health)", "Tricia Griffith (CEO of Progressive)",
               "Tory Burch (Founder of Tory Burch)", "Carol Tome (CEO of UPS)",
               "Leah Busque (Founder of TaskRabbit)", "Whitney Wolfe Herd (Founder of Bumble)",
               "Corie Barry (CEO of Best Buy)", "Melanie Perkins (Founder of Canva)",
               "Kathy Warden (CEO of Northrupp Grumman)", "Julia Hartz (Founder of EventBrite)",
               "Safra Katz (CEO of Oracle)")

if(USE_API) {
  d0 <- qual_data |>
    filter(!is.na(`choice-7`), !is.na(PROLIFIC_PID), Finished==1) |>
    mutate(
      # Determine female_pick
      female_pick = case_when(`choice-7` %in% all_women ~ 1,
                             TRUE ~ 0),

      # Extract pool (men vs women) and condition (control vs treat)
      pool = tolower(pool),
      cond = tolower(cond),

      # Create numeric codes
      women_pool = ifelse(pool == "women", 1, 0),  # women overrepresented
      men_pool = ifelse(pool == "men", 1, 0),      # women underrepresented
      gender_feedback = ifelse(cond == "treat", 1, 0),

      # Calculate base selections (number of women selected in first 6 choices)
      base_gender = rowSums(across(`choice-1`:`choice-6`, ~ . %in% all_women))
    ) |>
    # Process fairness scale
    mutate(
      across(c(fair1:fair3),
             ~ case_when(
               . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
               . == "Neither agree nor disagree" ~ 4,
               . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
               TRUE ~ NA_integer_))) |>
    mutate(
      # Fairness scale (fair1-fair3)
      fair1Z = (fair1 - mean(fair1, na.rm = TRUE)) / sd(fair1, na.rm = TRUE),
      fair2Z = (fair2 - mean(fair2, na.rm = TRUE)) / sd(fair2, na.rm = TRUE),
      fair3Z = (fair3 - mean(fair3, na.rm = TRUE)) / sd(fair3, na.rm = TRUE),
      fairness = (fair1Z + fair2Z + fair3Z) / 3
    ) |>
    dplyr::select(female_pick, pool, cond, women_pool, men_pool,
                  gender_feedback, base_gender, `choice-1`:`choice-7`,
                  race, gender, age,
                  fair1Z, fair2Z, fair3Z, fairness)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'Study-4-pilot.csv', row.names = FALSE, quote = TRUE)
}

qual_data$goals
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{pool} & Pool composition: men (women underrepresented) or women (women overrepresented). \\
\hline
\texttt{cond} & Feedback condition: control (no feedback) or treat (gender feedback). \\
\hline
\texttt{women\_pool} & Binary indicator (1 = women pool/women overrepresented, 0 = men pool). \\
\hline
\texttt{men\_pool} & Binary indicator (1 = men pool/women underrepresented, 0 = women pool). \\
\hline
\texttt{gender\_feedback} & Binary indicator (1 = gender feedback provided, 0 = control). \\
\hline
\texttt{female\_pick} & Binary indicator of whether participant selected a woman for their final selection. \\
\hline
\texttt{base\_gender} & Number of women selected in initial 6 choices (0-6). \\
\hline
\texttt{choice-1 to choice-7} & The selected candidates. \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\texttt{fair1Z-3Z} & Individual standardized scale items for Fairness scale. \\
\hline
\texttt{fairness} & Aggregated Fairness scale. \\
\hline
\end{tabular}
\end{table}


```{r include=FALSE, results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n\n')

## Sample size
cat('Total N:', nrow(d0), '\n\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)

## Race

race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

colnames(race_df) <- c("Percentage", "Race")

print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Cell sizes

cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(pool, cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)

## Initial Selections

cat('\n\nMean initial women selected (out of 6):\n')
d0 |>
  group_by(pool, cond) |>
  summarize(
    mean_base = mean(base_gender),
    sd_base = sd(base_gender),
    .groups = "drop"
  )
```

\newpage

## Cronbach's Alpha

```{r cronbach-alpha, echo=FALSE, results='markup'}
# Calculating Cronbach's Alpha for the Fairness scale
fairness_items <- d0[, c("fair1Z", "fair2Z", "fair3Z")]
alpha_fairness <- alpha(fairness_items)
cat("Cronbach's Alpha for Fairness Scale: ", alpha_fairness$total$raw_alpha, "\n\n")
```

\newpage

## Main Models

\newpage

## Models by Pool Representation

### Women Underrepresented in Pool (Men Pool)

```{r men-pool, echo=FALSE, results='markup'}
# Men pool model: main effect of gender feedback
model_men <- lm(female_pick ~ gender_feedback,
                data = d0 %>% filter(pool == "men"))

cat("=== WOMEN UNDERREPRESENTED IN POOL (MEN POOL) ===\n")
cat("Model: female_pick ~ gender_feedback\n\n")
robust_summary(model_men)
robust_confint(model_men)

# Cell means
cat("\n\nCell Means - Women Underrepresented:\n")
d0 %>%
  filter(pool == "men") %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### Women Overrepresented in Pool (Women Pool)

```{r women-pool, echo=FALSE, results='markup'}
# Women pool model: main effect of gender feedback
model_women <- lm(female_pick ~ gender_feedback,
                  data = d0 %>% filter(pool == "women"))

cat("=== WOMEN OVERREPRESENTED IN POOL (WOMEN POOL) ===\n")
cat("Model: female_pick ~ gender_feedback\n\n")
robust_summary(model_women)
robust_confint(model_women)

# Cell means
cat("\n\nCell Means - Women Overrepresented:\n")
d0 %>%
  filter(pool == "women") %>%
  group_by(cond) %>%
  summarise(
    n = n(),
    mean_female_pick = mean(female_pick) * 100,
    se = sd(female_pick) / sqrt(n()) * 100,
    .groups = "drop"
  )
```

\newpage

### Interaction Model

```{r interaction-model, echo=FALSE, results='markup'}
# Interaction model: tests if treatment effect differs by pool composition
model_interaction <- lm(female_pick ~ gender_feedback * women_pool,
                        data = d0)

cat("=== INTERACTION MODEL: GENDER FEEDBACK × POOL COMPOSITION ===\n")
cat("Model: female_pick ~ gender_feedback * women_pool\n\n")
robust_summary(model_interaction)
robust_confint(model_interaction)
```

\newpage

### Wald Test: Comparing Treatment Effects Across Pools

```{r wald-test, echo=FALSE, results='markup'}
cat("=== WALD TEST: DIFFERENCE IN TREATMENT EFFECTS BETWEEN POOLS ===\n\n")

# Calculate treatment effects for each pool
# Men pool (women underrepresented): just the gender_feedback coefficient
effect_men <- coef(model_men)["gender_feedback"]
se_men <- sqrt(diag(vcovHC(model_men, type = "HC3")))["gender_feedback"]

# Women pool (women overrepresented): just the gender_feedback coefficient
effect_women <- coef(model_women)["gender_feedback"]
se_women <- sqrt(diag(vcovHC(model_women, type = "HC3")))["gender_feedback"]

# Calculate difference in treatment effects
diff_effects <- effect_men - effect_women

# Standard error of the difference (assuming independence)
se_diff <- sqrt(se_men^2 + se_women^2)

# Wald test statistic
wald_stat <- diff_effects / se_diff

# P-value (two-tailed)
p_value <- 2 * (1 - pnorm(abs(wald_stat)))

# 95% CI for the difference
ci_lower <- diff_effects - 1.96 * se_diff
ci_upper <- diff_effects + 1.96 * se_diff

# Print results
cat("Treatment Effect (Women Underrepresented): ", sprintf("%.4f", effect_men),
    " (SE = ", sprintf("%.4f", se_men), ")\n", sep = "")
cat("Treatment Effect (Women Overrepresented):   ", sprintf("%.4f", effect_women),
    " (SE = ", sprintf("%.4f", se_women), ")\n\n", sep = "")

cat("Difference in Treatment Effects: ", sprintf("%.4f", diff_effects), "\n", sep = "")
cat("Standard Error of Difference:    ", sprintf("%.4f", se_diff), "\n", sep = "")
cat("Wald Statistic (z):              ", sprintf("%.4f", wald_stat), "\n", sep = "")
cat("P-value (two-tailed):            ", sprintf("%.4f", p_value), "\n", sep = "")
cat("95% CI for Difference:           [", sprintf("%.4f", ci_lower), ", ",
    sprintf("%.4f", ci_upper), "]\n\n", sep = "")

if (p_value < 0.001) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.001).\n")
  cat("Gender feedback increases selection of women when women are underrepresented,\n")
  cat("but decreases selection when women are overrepresented.\n")
} else if (p_value < 0.01) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.01).\n")
  cat("Gender feedback increases selection of women when women are underrepresented,\n")
  cat("but decreases selection when women are overrepresented.\n")
} else if (p_value < 0.05) {
  cat("INTERPRETATION: The treatment effect is SIGNIFICANTLY different between pools (p < 0.05).\n")
  cat("Gender feedback increases selection of women when women are underrepresented,\n")
  cat("but decreases selection when women are overrepresented.\n")
} else {
  cat("INTERPRETATION: The treatment effect does NOT significantly differ between pools (p >= 0.05).\n")
}

cat("\nNote: This Wald test formally tests whether the treatment effect when women are\n")
cat("underrepresented is significantly different from the treatment effect when women\n")
cat("are overrepresented. The test uses robust (HC3) standard errors.\n")
```

\newpage


# Visualization

## Combined Figure: Pool Composition Effect

```{r fig-combined, fig.cap="Effect of Gender Feedback by Pool Composition", fig.width=10, fig.height=8, echo=FALSE}
# Run statistical tests to determine significance levels
test_men <- t.test(female_pick ~ gender_feedback, data=d0 %>% filter(pool == "men"))
test_women <- t.test(female_pick ~ gender_feedback, data=d0 %>% filter(pool == "women"))

# Function to get significance stars
get_sig_stars <- function(p_value) {
  if (p_value < 0.001) return("***")
  else if (p_value < 0.01) return("**")
  else if (p_value < 0.05) return("*")
  else return("n.s.")
}

sig_men <- get_sig_stars(test_men$p.value)
sig_women <- get_sig_stars(test_women$p.value)

# Prepare plot data for men pool (women underrepresented)
dmen_plot <- d0 %>%
  filter(pool == "men") %>%
  dplyr::select(gender_feedback, female_pick) %>%
  group_by(gender_feedback) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(gender_feedback = case_when(gender_feedback==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = gender_feedback)

# Prepare plot data for women pool (women overrepresented)
dwomen_plot <- d0 %>%
  filter(pool == "women") %>%
  dplyr::select(gender_feedback, female_pick) %>%
  group_by(gender_feedback) %>%
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) %>%
  mutate(gender_feedback = case_when(gender_feedback==1 ~ "Treatment",
                          TRUE ~ "Control")) %>%
  rename(Condition = gender_feedback)

# Combine into single dataframe
df_combined <- bind_rows(
  dmen_plot %>% mutate(Category = "Women Underrepresented\nin Pool"),
  dwomen_plot %>% mutate(Category = "Women Overrepresented\nin Pool")
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('Women Underrepresented\nin Pool', 'Women Overrepresented\nin Pool')))

# Create combined plot
p_combined <- ggplot(df_combined, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 7, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~Category, nrow = 1, strip.position = "bottom") +
  geom_segment(data = df_combined %>% filter(Category == "Women Underrepresented\nin Pool" & Condition == "Treatment"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_segment(data = df_combined %>% filter(Category == "Women Overrepresented\nin Pool" & Condition == "Control"),
                aes(x = 1, xend = 2, y = freq*100 + se + 10, yend = freq*100 + se + 10),
                inherit.aes = FALSE) +
  geom_text(data = df_combined %>% filter(Category == "Women Underrepresented\nin Pool" & Condition == "Treatment"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_men),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  geom_text(data = df_combined %>% filter(Category == "Women Overrepresented\nin Pool" & Condition == "Control"),
                aes(x = 1.5, y = freq*100 + se + 10, label = sig_women),
                inherit.aes = FALSE, vjust = 0, size = 7) +
  theme_bw() +
  scale_fill_manual(values = c("#990000", "#011F5B"), labels = c("No gender feedback provided", "Gender feedback provided"), "") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("Control" = "Not\nShown", "Treatment" = "Shown")) +
  labs(x = "", y = "% Selecting Women") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.direction = "horizontal",
        legend.text = element_text(size = 18),
        legend.key.size = unit(5, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(size = 18, color = "black"),
        plot.title = element_text(hjust = 0.5),
        axis.title.y = element_text(size = 18, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 18, color = "black"),
        strip.text = element_text(size = 18, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

# Display the plot
print(p_combined)

# Save the plot
ggsave("Study-4-pilot-figure.pdf", plot = p_combined, width = 10, height = 8, units = "in", device = cairo_pdf)
```

\newpage

# Mediation Analyses

## Fairness Scale

```{r mediation-fairness, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

# Define function for Sobel Test
sobel_test <- function(med.fit, out.fit, mediator) {
  med.se <- sqrt(diag(vcovHC(med.fit)))[mediator]
  out.se <- sqrt(diag(vcovHC(out.fit)))[mediator]
  sobel_test_statistic <- coef(out.fit)[mediator] / sqrt(vcovHC(out.fit)[mediator, mediator])
  sobel_p_value <- 2 * (1 - pnorm(abs(sobel_test_statistic)))
  list(statistic = sobel_test_statistic, p_value = sobel_p_value, se = out.se)
}

cat("=======================================================\n")
cat("MEDIATION ANALYSIS: FAIRNESS SCALE\n")
cat("=======================================================\n\n")

# Direct effect model
dir.fit.fairness <- lm(female_pick ~ gender_feedback, data=d0)

# Mediator model
med.fit.fairness <- lm(fairness ~ gender_feedback, data = d0)

# Outcome model including mediator
out.fit.fairness <- lm(female_pick ~ gender_feedback + fairness, data = d0)

# Mediation analysis
med.out.fairness <- mediate(med.fit.fairness, out.fit.fairness, boot = TRUE,
                            treat = "gender_feedback", boot.ci.type = "perc",
                            mediator = "fairness", sims = 10000)

# Sensitivity analysis
sens.out.fairness <- medsens(med.out.fairness, rho.by = 0.01, eps=.01,
                             effect.type = "indirect", sims = 10000)

# Sobel test for fairness
sobel.fairness <- sobel_test(med.fit.fairness, out.fit.fairness, "fairness")

# Print results
cat("Sobel test for Fairness:\n")
print(sobel.fairness)
cat("\n")
summary(med.out.fairness)
cat("\n")
plot(sens.out.fairness, main = "Sensitivity Analysis: Fairness Scale")
```

\newpage

# Conditional Mediation by Pool

## Mediation in Men Pool (Women Underrepresented)

```{r mediation-men-pool, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: MEN POOL (WOMEN UNDERREPRESENTED)\n")
cat("=======================================================\n\n")

# Filter data for men pool only
d_men <- d0 %>% filter(pool == "men")

# -----------------------------
# Fairness - Men Pool
# -----------------------------

cat("--- FAIRNESS SCALE - MEN POOL ---\n\n")

# Mediator model
med.fit.fairness.men <- lm(fairness ~ gender_feedback, data = d_men)

# Outcome model including mediator
out.fit.fairness.men <- lm(female_pick ~ gender_feedback + fairness, data = d_men)

# Mediation analysis
med.out.fairness.men <- mediate(med.fit.fairness.men, out.fit.fairness.men, boot = TRUE,
                                treat = "gender_feedback", boot.ci.type = "perc",
                                mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.men <- sobel_test(med.fit.fairness.men, out.fit.fairness.men, "fairness")

cat("Sobel test for Fairness (Men Pool):\n")
print(sobel.fairness.men)
cat("\n")
summary(med.out.fairness.men)
```

\newpage

## Mediation in Women Pool (Women Overrepresented)

```{r mediation-women-pool, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

cat("=======================================================\n")
cat("CONDITIONAL MEDIATION: WOMEN POOL (WOMEN OVERREPRESENTED)\n")
cat("=======================================================\n\n")

# Filter data for women pool only
d_women <- d0 %>% filter(pool == "women")

# -----------------------------
# Fairness - Women Pool
# -----------------------------

cat("--- FAIRNESS SCALE - WOMEN POOL ---\n\n")

# Mediator model
med.fit.fairness.women <- lm(fairness ~ gender_feedback, data = d_women)

# Outcome model including mediator
out.fit.fairness.women <- lm(female_pick ~ gender_feedback + fairness, data = d_women)

# Mediation analysis
med.out.fairness.women <- mediate(med.fit.fairness.women, out.fit.fairness.women, boot = TRUE,
                                  treat = "gender_feedback", boot.ci.type = "perc",
                                  mediator = "fairness", sims = 10000)

# Sobel test
sobel.fairness.women <- sobel_test(med.fit.fairness.women, out.fit.fairness.women, "fairness")

cat("Sobel test for Fairness (Women Pool):\n")
print(sobel.fairness.women)
cat("\n")
summary(med.out.fairness.women)
```

\newpage

# Moderated Mediation: Formal Test of Pool Differences

## Fairness Scale

```{r moderated-mediation-fairness, echo=FALSE, results='markup'}
# Set seed for reproducibility
set.seed(123)

cat("=======================================================\n")
cat("MODERATED MEDIATION: FAIRNESS SCALE\n")
cat("Testing if pool composition moderates the mediation effect\n")
cat("=======================================================\n\n")

# Model with interactions
mod_med_a_fairness <- lm(fairness ~ gender_feedback * women_pool, data = d0)
mod_med_b_fairness <- lm(female_pick ~ gender_feedback * women_pool + fairness * women_pool, data = d0)

cat("--- Path A: Feedback → Fairness (moderated by pool) ---\n")
robust_summary(mod_med_a_fairness)
cat("\n\n")

cat("--- Path B: Fairness → Outcome (moderated by pool, controlling for feedback) ---\n")
robust_summary(mod_med_b_fairness)
cat("\n\n")

# Calculate indirect effects
a_men <- coef(mod_med_a_fairness)["gender_feedback"]
b_men <- coef(mod_med_b_fairness)["fairness"]
indirect_men <- a_men * b_men

a_women <- coef(mod_med_a_fairness)["gender_feedback"] + coef(mod_med_a_fairness)["gender_feedback:women_pool"]
b_women <- coef(mod_med_b_fairness)["fairness"] + coef(mod_med_b_fairness)["women_pool:fairness"]
indirect_women <- a_women * b_women

index_modmed_fairness <- indirect_women - indirect_men

cat("--- INDIRECT EFFECTS ---\n")
cat("Indirect effect (Men Pool, women underrepresented): ", round(indirect_men, 4), "\n")
cat("Indirect effect (Women Pool, women overrepresented): ", round(indirect_women, 4), "\n")
cat("\nIndex of Moderated Mediation: ", round(index_modmed_fairness, 4), "\n\n")

# Bootstrap CI
boot_modmed_fairness <- function(data, indices) {
  d <- data[indices,]
  m1 <- lm(fairness ~ gender_feedback * women_pool, data = d)
  m2 <- lm(female_pick ~ gender_feedback * women_pool + fairness * women_pool, data = d)

  a_men <- coef(m1)["gender_feedback"]
  b_men <- coef(m2)["fairness"]
  a_women <- coef(m1)["gender_feedback"] + coef(m1)["gender_feedback:women_pool"]
  b_women <- coef(m2)["fairness"] + coef(m2)["women_pool:fairness"]

  return((a_women * b_women) - (a_men * b_men))
}

boot_results_fairness <- boot(data = d0, statistic = boot_modmed_fairness, R = 10000)
boot_ci_fairness <- boot.ci(boot_results_fairness, type = "perc")

cat("Bootstrap 95% CI for Index of Moderated Mediation:\n")
print(boot_ci_fairness)
cat("\n")

if (boot_ci_fairness$percent[4] > 0 | boot_ci_fairness$percent[5] < 0) {
  cat("INTERPRETATION: The mediation effect DIFFERS significantly between pools.\n")
} else {
  cat("INTERPRETATION: The mediation effect does NOT differ significantly between pools.\n")
  cat("(Consistent with your theory that motivation mediates in both pools)\n")
}
```


