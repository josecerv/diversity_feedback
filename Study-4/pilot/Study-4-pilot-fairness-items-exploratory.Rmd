---
title: "Study 4 Pilot - Exploratory Analysis: Individual Fairness Items"
subtitle: "Testing Individual Fairness Items as Mediators (Women Overrepresented Pool Only)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 3
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
library(ggplot2)
library(kableExtra)
library(psych)
library(mediation)
```

```{r include=FALSE}
if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}

robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
```

# Data Processing

```{r include=FALSE}
# Pull directly from Qualtrics API
qual_data <- fetch_survey(surveyID='SV_eysJmstT7Zxvd2K',
                   label = T,
                   convert = F,
                   force_request = T)

# Define all women leaders (from Study 4)
all_women <- c("Jane Fraser (CEO of Citigroup)", "Oprah Winfrey (CEO of Oprah Winfrey Network)",
               "Delphine Arnault (CEO of Christian Dior)", "Michelle Buck (CEO of The Hershey Company)",
               "Mary Barra (CEO of General Motors)", "Rosalind Brewer (CEO of Walgreens)",
               "Anne Wojcicki (CEO of 23andMe)", "Arianna Huffington (Co-founder of Huffington Post)",
               "Karen Lynch (CEO of CVS Health)", "Tricia Griffith (CEO of Progressive)",
               "Tory Burch (Founder of Tory Burch)", "Carol Tome (CEO of UPS)",
               "Leah Busque (Founder of TaskRabbit)", "Whitney Wolfe Herd (Founder of Bumble)",
               "Corie Barry (CEO of Best Buy)", "Melanie Perkins (Founder of Canva)",
               "Kathy Warden (CEO of Northrupp Grumman)", "Julia Hartz (Founder of EventBrite)",
               "Safra Katz (CEO of Oracle)")

d0 <- qual_data |>
  filter(!is.na(`choice-7`), !is.na(PROLIFIC_PID), Finished==1) |>
  mutate(
    # Determine female_pick
    female_pick = case_when(`choice-7` %in% all_women ~ 1,
                           TRUE ~ 0),

    # Extract pool (men vs women) and condition (control vs treat)
    pool = tolower(pool),
    cond = tolower(cond),

    # Create numeric codes
    women_pool = ifelse(pool == "women", 1, 0),  # women overrepresented
    men_pool = ifelse(pool == "men", 1, 0),      # women underrepresented
    gender_feedback = ifelse(cond == "treat", 1, 0),

    # Calculate base selections (number of women selected in first 6 choices)
    base_gender = rowSums(across(`choice-1`:`choice-6`, ~ . %in% all_women)),

    # Extract date information
    collection_date = as.Date(StartDate)
  ) |>
  # Process fairness scale items
  mutate(
    across(c(fair1:fair3),
           ~ case_when(
             . == "Strongly disagree" ~ 1, . == "Disagree" ~ 2, . == "Somewhat disagree" ~ 3,
             . == "Neither agree nor disagree" ~ 4,
             . == "Somewhat agree" ~ 5, . == "Agree" ~ 6, . == "Strongly agree" ~ 7,
             TRUE ~ NA_integer_))
  ) |>
  # FILTER FOR WOMEN POOL ONLY (women overrepresented)
  filter(pool == "women") |>
  # Create date-specific fairness variables
  mutate(
    # November 12 items (old fairness items)
    fair1_nov12 = ifelse(collection_date == as.Date("2025-11-12"), fair1, NA),
    fair2_nov12 = ifelse(collection_date == as.Date("2025-11-12"), fair2, NA),
    fair3_nov12 = ifelse(collection_date == as.Date("2025-11-12"), fair3, NA),

    # November 14 items (new fairness items)
    fair1_nov14 = ifelse(collection_date == as.Date("2025-11-14"), fair1, NA),
    fair2_nov14 = ifelse(collection_date == as.Date("2025-11-14"), fair2, NA),
    fair3_nov14 = ifelse(collection_date == as.Date("2025-11-14"), fair3, NA)
  ) |>
  # Standardize all items
  mutate(
    # Nov 12 items (standardized)
    fair1_nov12_Z = (fair1_nov12 - mean(fair1_nov12, na.rm = TRUE)) / sd(fair1_nov12, na.rm = TRUE),
    fair2_nov12_Z = (fair2_nov12 - mean(fair2_nov12, na.rm = TRUE)) / sd(fair2_nov12, na.rm = TRUE),
    fair3_nov12_Z = (fair3_nov12 - mean(fair3_nov12, na.rm = TRUE)) / sd(fair3_nov12, na.rm = TRUE),

    # Nov 14 items (standardized)
    fair1_nov14_Z = (fair1_nov14 - mean(fair1_nov14, na.rm = TRUE)) / sd(fair1_nov14, na.rm = TRUE),
    fair2_nov14_Z = (fair2_nov14 - mean(fair2_nov14, na.rm = TRUE)) / sd(fair2_nov14, na.rm = TRUE),
    fair3_nov14_Z = (fair3_nov14 - mean(fair3_nov14, na.rm = TRUE)) / sd(fair3_nov14, na.rm = TRUE)
  ) |>
  dplyr::select(female_pick, pool, cond, women_pool, men_pool,
                gender_feedback, base_gender, `choice-1`:`choice-7`,
                race, gender, age, collection_date,
                fair1_nov12, fair2_nov12, fair3_nov12,
                fair1_nov14, fair2_nov14, fair3_nov14,
                fair1_nov12_Z, fair2_nov12_Z, fair3_nov12_Z,
                fair1_nov14_Z, fair2_nov14_Z, fair3_nov14_Z)

# Calculate the number of excluded participants
num_excluded <- nrow(qual_data) - nrow(d0)
```

\newpage

# Sample Description

```{r include=FALSE, results='markup'}
## Excluded participants
cat('Excluded Participants (including men pool):', num_excluded, '\n\n')

## Sample size
cat('Total N (Women Pool Only):', nrow(d0), '\n\n')

## Sample by date
cat('Sample by Collection Date:\n')
table(d0$collection_date)
cat('\n\n')

## Gender
gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)
gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]
colnames(gender_df) <- c("Percentage", "gender")
print(gender_df)

## Cell sizes
cat('\n\nCell Sizes by Condition:\n')
cell_counts <- d0 |>
  group_by(cond) |>
  summarize(n = n(), .groups = "drop")
print(cell_counts)
```

\newpage

# Fairness Item Descriptions

## November 12, 2025 Items (Old Fairness Scale)

1. **fair1_nov12**: "In making my decision about who to select as my seventh panelist, I considered whether or not some people were **treated differently** than others."

2. **fair2_nov12**: "When making my decision about who to select as my seventh panelist, I considered whether or not I had **acted unfairly**."

3. **fair3_nov12**: "When making my decision about who to select as my seventh panelist, I considered whether or not someone could have been **denied his or her rights**."

## November 14, 2025 Items (New Fairness Scale)

1. **fair1_nov14**: "When deciding who to add as my seventh panelist, I prioritized **achieving a degree of balance** in the representation of men and women."

2. **fair2_nov14**: "An important factor when deciding who to add as my seventh panelist was **avoiding extreme over- or under-representation** of men or women."

3. **fair3_nov14**: "I aimed to ensure that **neither men nor women were left out** when making my final decision."

\newpage

# Individual Item Mediation Analyses

```{r include=FALSE}
# Set seed for reproducibility
set.seed(123)

# Define function for Sobel Test
sobel_test <- function(med.fit, out.fit, mediator) {
  med.se <- sqrt(diag(vcovHC(med.fit)))[mediator]
  out.se <- sqrt(diag(vcovHC(out.fit)))[mediator]
  sobel_test_statistic <- coef(out.fit)[mediator] / sqrt(vcovHC(out.fit)[mediator, mediator])
  sobel_p_value <- 2 * (1 - pnorm(abs(sobel_test_statistic)))
  list(statistic = sobel_test_statistic, p_value = sobel_p_value, se = out.se)
}
```

## November 12 Item 1: Treated Differently

```{r mediation-nov12-item1, echo=FALSE, results='markup'}
set.seed(123)

# Filter for Nov 12 data only
d_nov12 <- d0 %>% filter(!is.na(fair1_nov12_Z))

cat("=======================================================\n")
cat("NOV 12 ITEM 1: TREATED DIFFERENTLY\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov12), "\n\n")

# Mediator model
med.fit <- lm(fair1_nov12_Z ~ gender_feedback, data = d_nov12)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair1_nov12_Z, data = d_nov12)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair1_nov12_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair1_nov12_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

## November 12 Item 2: Acted Unfairly

```{r mediation-nov12-item2, echo=FALSE, results='markup'}
set.seed(123)

cat("=======================================================\n")
cat("NOV 12 ITEM 2: ACTED UNFAIRLY\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov12), "\n\n")

# Mediator model
med.fit <- lm(fair2_nov12_Z ~ gender_feedback, data = d_nov12)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair2_nov12_Z, data = d_nov12)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair2_nov12_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair2_nov12_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

## November 12 Item 3: Denied Rights

```{r mediation-nov12-item3, echo=FALSE, results='markup'}
set.seed(123)

cat("=======================================================\n")
cat("NOV 12 ITEM 3: DENIED RIGHTS\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov12), "\n\n")

# Mediator model
med.fit <- lm(fair3_nov12_Z ~ gender_feedback, data = d_nov12)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair3_nov12_Z, data = d_nov12)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair3_nov12_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair3_nov12_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

## November 14 Item 1: Achieving Balance

```{r mediation-nov14-item1, echo=FALSE, results='markup'}
set.seed(123)

# Filter for Nov 14 data only
d_nov14 <- d0 %>% filter(!is.na(fair1_nov14_Z))

cat("=======================================================\n")
cat("NOV 14 ITEM 1: ACHIEVING BALANCE\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov14), "\n\n")

# Mediator model
med.fit <- lm(fair1_nov14_Z ~ gender_feedback, data = d_nov14)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair1_nov14_Z, data = d_nov14)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair1_nov14_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair1_nov14_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

## November 14 Item 2: Avoiding Extremes

```{r mediation-nov14-item2, echo=FALSE, results='markup'}
set.seed(123)

cat("=======================================================\n")
cat("NOV 14 ITEM 2: AVOIDING EXTREMES\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov14), "\n\n")

# Mediator model
med.fit <- lm(fair2_nov14_Z ~ gender_feedback, data = d_nov14)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair2_nov14_Z, data = d_nov14)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair2_nov14_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair2_nov14_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

## November 14 Item 3: No One Left Out

```{r mediation-nov14-item3, echo=FALSE, results='markup'}
set.seed(123)

cat("=======================================================\n")
cat("NOV 14 ITEM 3: NO ONE LEFT OUT\n")
cat("=======================================================\n\n")
cat("N =", nrow(d_nov14), "\n\n")

# Mediator model
med.fit <- lm(fair3_nov14_Z ~ gender_feedback, data = d_nov14)

# Outcome model including mediator
out.fit <- lm(female_pick ~ gender_feedback + fair3_nov14_Z, data = d_nov14)

# Mediation analysis
med.out <- mediate(med.fit, out.fit, boot = TRUE,
                   treat = "gender_feedback", boot.ci.type = "perc",
                   mediator = "fair3_nov14_Z", sims = 10000)

# Sobel test
sobel <- sobel_test(med.fit, out.fit, "fair3_nov14_Z")

# Print results
cat("Sobel test:\n")
print(sobel)
cat("\n")
summary(med.out)
```

\newpage

# Summary Table

```{r summary-table, echo=FALSE, results='asis'}
# Create summary table manually based on the results
summary_data <- data.frame(
  Date = c("Nov 12", "Nov 12", "Nov 12", "Nov 14", "Nov 14", "Nov 14"),
  Item = c("Treated Differently", "Acted Unfairly", "Denied Rights",
           "Achieving Balance", "Avoiding Extremes", "No One Left Out"),
  Description = c(
    "Considered if people were treated differently",
    "Considered if I had acted unfairly",
    "Considered if someone was denied their rights",
    "Prioritized achieving balance",
    "Avoided extreme over-/under-representation",
    "Ensured no one was left out"
  )
)

kable(summary_data, caption = "Individual Fairness Items Tested", booktabs = TRUE) %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```

Note: Results for each item are shown in the previous sections. Look for:
- **Indirect Effect (ACME)**: The mediation effect
- **95% CI**: Confidence interval for the indirect effect
- **p-value**: Statistical significance

Items with p < 0.05 for ACME indicate successful mediation.
