---
title: "2x2x2 Design Simulation"
subtitle: "Context (Business vs Nursing) × Pool Composition × Gender Feedback"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 2
    fig_caption: true
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.width = 10,
	fig.height = 6
)
library(dplyr)
library(ggplot2)
library(broom)
library(knitr)
library(tidyverse)
library(kableExtra)
```

\newpage

# Study Design Overview

## Design Structure

1. **Context**
   - Business context (women historically underrepresented)
   - Nursing context (women historically overrepresented)

2. **Pool Composition**
   - Women underrepresented in candidate pool
   - Women overrepresented in candidate pool

3. **Feedback**
   - Gender feedback provided
   - No gender feedback (control)

## Predicted Patterns

\begin{table}[h]
\centering
\begin{tabular}{p{4.5cm}p{5cm}r}
\hline
\textbf{Pool Composition} & \textbf{Context} & \textbf{Expected Treatment Effect} \\
\hline
\multicolumn{3}{l}{\textit{Women Underrepresented in Pool}} \\
\hspace{0.5cm} & Business (historically underrepresented) & +20\% \\
\hspace{0.5cm} & Nursing (historically overrepresented) & +45\% \\
\hline
\multicolumn{3}{l}{\textit{Women Overrepresented in Pool}} \\
\hspace{0.5cm} & Business (historically underrepresented) & -11\% \\
\hspace{0.5cm} & Nursing (historically overrepresented) & 0\% \\
\hline
\end{tabular}
\end{table}

\vspace{0.5cm}

**Key predictions:**

- **Business context effects** based on actual Study 3 data (+20\% / -11\%)

- **Nursing context** hypothesized to show amplified positive effect when women underrepresented (+45\%), but no correction when overrepresented (0\%)

- N~2500 used in simulation

\newpage


```{r simulation-setup, include=FALSE}
set.seed(42)
n_per_cell <- 313  # Total N = 2504 (8 cells) - larger sample for exploratory design

# Baseline rates (control condition, no feedback)
# Based on actual Study 3 control group means
baseline_business_under <- 0.336  # Business, women underrepresented pool
baseline_business_over <- 0.729   # Business, women overrepresented pool
baseline_nursing_under <- 0.336   # Nursing, women underrepresented pool
baseline_nursing_over <- 0.729    # Nursing, women overrepresented pool

# Treatment effects (gender feedback)
# Business effects from actual Study 3 data
effect_business_under <- 0.202   # +20.2pp (from Study 3 data)
effect_business_over <- -0.111   # -11.1pp (from Study 3 data)

# Nursing effects hypothesized to show stronger asymmetry
# When women underrepresented: stronger positive effect in historically female field
# When women overrepresented: no correction needed (already aligned with norms)
effect_nursing_under <- 0.45     # +45pp - amplified effect
effect_nursing_over <- 0.00      # 0pp - no correction (women already overrep in female field)

# Create simulated data
sim_data <- expand.grid(
  context = c("Business", "Nursing"),
  pool_composition = c("Women_Under", "Women_Over"),
  feedback = c("No_Feedback", "Feedback"),
  id = 1:n_per_cell
) %>%
  mutate(
    # Numeric codes
    nursing_context = ifelse(context == "Business", 0, 1),
    overrepresented = ifelse(pool_composition == "Women_Under", 0, 1),
    gender_feedback = ifelse(feedback == "Feedback", 1, 0),

    # Expected probability based on condition
    expected_prob = case_when(
      context == "Business" & pool_composition == "Women_Under" & feedback == "No_Feedback" ~ baseline_business_under,
      context == "Business" & pool_composition == "Women_Under" & feedback == "Feedback" ~ baseline_business_under + effect_business_under,
      context == "Business" & pool_composition == "Women_Over" & feedback == "No_Feedback" ~ baseline_business_over,
      context == "Business" & pool_composition == "Women_Over" & feedback == "Feedback" ~ baseline_business_over + effect_business_over,
      context == "Nursing" & pool_composition == "Women_Under" & feedback == "No_Feedback" ~ baseline_nursing_under,
      context == "Nursing" & pool_composition == "Women_Under" & feedback == "Feedback" ~ baseline_nursing_under + effect_nursing_under,
      context == "Nursing" & pool_composition == "Women_Over" & feedback == "No_Feedback" ~ baseline_nursing_over,
      context == "Nursing" & pool_composition == "Women_Over" & feedback == "Feedback" ~ baseline_nursing_over + effect_nursing_over
    ),

    # Use expected probability directly (not simulated) to show true theoretical pattern
    female_pick = expected_prob
  )

# Summary statistics
summary_stats <- sim_data %>%
  group_by(context, pool_composition, feedback) %>%
  summarise(
    n = n(),
    mean_selection = mean(female_pick),
    se = sd(female_pick) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    condition_label = paste(context, pool_composition, feedback, sep = "_")
  )
```



## Simulated Cell Means

```{r results='markup'}
library(kableExtra)
summary_table <- summary_stats %>%
  select(context, pool_composition, feedback, mean_selection) %>%
  pivot_wider(
    names_from = feedback,
    values_from = mean_selection
  ) %>%
  mutate(
    Treatment_Effect = Feedback - No_Feedback,
    across(where(is.numeric), ~round(., 3))
  )

kable(summary_table,
      format = "latex",
      booktabs = TRUE,
      caption = "Proportion Selecting Women by Condition",
      col.names = c("Context", "Pool Composition", "Control", "Treatment", "Effect")) %>%
  column_spec(5, color = ifelse(summary_table$Treatment_Effect > 0, "blue", "red"))
```


\newpage

# Statistical Models

## Three-Way Interaction Model

**Model specification:**

$$\text{female\_pick} = \beta_0 + \beta_1 \text{gender\_feedback} + \beta_2 \text{overrepresented} + \beta_3 \text{nursing\_context}$$
$$+ \beta_4 (\text{gender\_feedback} \times \text{overrepresented})$$
$$+ \beta_5 (\text{gender\_feedback} \times \text{nursing\_context})$$
$$+ \beta_6 (\text{overrepresented} \times \text{nursing\_context})$$
$$+ \beta_7 (\text{gender\_feedback} \times \text{overrepresented} \times \text{nursing\_context}) + \epsilon$$

```{r three-way-model, echo=FALSE, results='markup'}
# Main model with three-way interaction
model_3way <- lm(female_pick ~ gender_feedback * overrepresented * nursing_context,
                 data = sim_data)

summary(model_3way)
```

\newpage

## Alternative Model: Separate Models by Context

We can also estimate the effect separately within each context and then compare the interaction terms.

**Business context model:**

$$\text{female\_pick} = \beta_0 + \beta_1 \text{gender\_feedback} + \beta_2 \text{overrepresented} + \beta_3 (\text{gender\_feedback} \times \text{overrepresented}) + \epsilon$$

**Nursing context model:**

$$\text{female\_pick} = \gamma_0 + \gamma_1 \text{gender\_feedback} + \gamma_2 \text{overrepresented} + \gamma_3 (\text{gender\_feedback} \times \text{overrepresented}) + \epsilon$$

```{r separate-models, echo=FALSE, results='markup'}
# Business context only
model_business <- lm(female_pick ~ gender_feedback * overrepresented,
                     data = sim_data %>% filter(context == "Business"))

cat("=== BUSINESS CONTEXT ===\n")
summary(model_business)

# Nursing context only
model_nursing <- lm(female_pick ~ gender_feedback * overrepresented,
                    data = sim_data %>% filter(context == "Nursing"))

cat("\n=== NURSING CONTEXT ===\n")
summary(model_nursing)
```

### Wald Test: Comparing Interaction Coefficients

The key test is whether $\beta_3$ (Business interaction) differs significantly from $\gamma_3$ (Nursing interaction).

```{r compare-interactions, results='markup'}
business_int <- coef(model_business)["gender_feedback:overrepresented"]
nursing_int <- coef(model_nursing)["gender_feedback:overrepresented"]

# Standard errors
business_se <- summary(model_business)$coefficients["gender_feedback:overrepresented", "Std. Error"]
nursing_se <- summary(model_nursing)$coefficients["gender_feedback:overrepresented", "Std. Error"]

# Difference and test
diff <- nursing_int - business_int
diff_se <- sqrt(business_se^2 + nursing_se^2)
z_stat <- diff / diff_se
p_val <- 2 * (1 - pnorm(abs(z_stat)))

cat("WALD TEST")
cat("================================\n\n")
cat("Business context interaction (b3):", round(business_int * 100, 2), "pp (SE =", round(business_se * 100, 2), ")\n")
cat("Nursing context interaction (g3): ", round(nursing_int * 100, 2), "pp (SE =", round(nursing_se * 100, 2), ")\n\n")
cat("Difference (g3 - b3):             ", round(diff * 100, 2), "pp\n")
cat("P-value:                          ", round(p_val, 4), "\n\n")
```

\newpage

# Visualizations

## Figure 1: Women Underrepresented in Pool

```{r fig1-underrep, fig.cap="Women Underrepresented in Candidate Pool", fig.height=5}
# Prepare data for women underrepresented
plot_data_under <- summary_stats %>%
  filter(pool_composition == "Women_Under") %>%
  mutate(
    feedback_label = ifelse(feedback == "Feedback", "Treatment", "Control"),
    context_label = ifelse(context == "Business",
                          "Business Context\n(Women Historically Underrepresented)",
                          "Nursing Context\n(Women Historically Overrepresented)")
  )

p1 <- ggplot(plot_data_under, aes(x = feedback_label, y = mean_selection * 100,
                                   fill = feedback_label)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", mean_selection * 100)),
            vjust = 3, size = 5, color = "white", fontface = "bold") +
  facet_wrap(~ context_label, nrow = 1) +
  scale_fill_manual(values = c("#990000", "#011F5B"),
                   labels = c("No gender feedback", "Gender feedback provided")) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                    limits = c(0, 100),
                    breaks = seq(0, 100, 25)) +
  scale_x_discrete(labels = c("Control\n(No Gender Feedback)", "Treatment\n(Gender Feedback)")) +
  labs(
    x = "",
    y = "% Selecting Women",
    fill = ""
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 11, face = "bold"),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

print(p1)
```

\newpage

## Figure 2: Women Overrepresented in Pool

```{r fig2-overrep, fig.cap="Women Overrepresented in Candidate Pool", fig.height=5}
# Prepare data for women overrepresented
plot_data_over <- summary_stats %>%
  filter(pool_composition == "Women_Over") %>%
  mutate(
    feedback_label = ifelse(feedback == "Feedback", "Treatment", "Control"),
    context_label = ifelse(context == "Business",
                          "Business Context\n(Women Historically Underrepresented)",
                          "Nursing Context\n(Women Historically Overrepresented)")
  )

p2 <- ggplot(plot_data_over, aes(x = feedback_label, y = mean_selection * 100,
                                  fill = feedback_label)) +
  geom_bar(stat = "identity", width = 0.7) +
  geom_text(aes(label = sprintf("%.1f%%", mean_selection * 100)),
            vjust = 3, size = 5, color = "white", fontface = "bold") +
  facet_wrap(~ context_label, nrow = 1) +
  scale_fill_manual(values = c("#990000", "#011F5B"),
                   labels = c("No gender feedback", "Gender feedback provided")) +
  scale_y_continuous(labels = function(x) paste0(x, "%"),
                    limits = c(0, 100),
                    breaks = seq(0, 100, 25)) +
  scale_x_discrete(labels = c("Control\n(No Gender Feedback)", "Treatment\n(Gender Feedback)")) +
  labs(
    x = "",
    y = "% Selecting Women",
    fill = ""
  ) +
  theme_bw() +
  theme(
    legend.position = "bottom",
    legend.direction = "horizontal",
    legend.text = element_text(size = 12),
    strip.text = element_text(size = 11, face = "bold"),
    axis.text.x = element_text(size = 11),
    axis.text.y = element_text(size = 11),
    axis.title.y = element_text(size = 12),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank()
  )

print(p2)
```
