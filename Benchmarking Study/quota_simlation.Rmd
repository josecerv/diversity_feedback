---
title: "Benchmarking Study: Descriptive Feedback vs. Quotas"
subtitle: "Supplementary Analysis for Online Appendix"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 2
    fig_caption: true
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	results = "asis"
)
library(dplyr)
library(lmtest)
library(sandwich)
library(car)
library(knitr)
library(kableExtra)
library(tidyverse)
library(stargazer)
```

```{r helper-functions, include=FALSE}
# Determine output format
if (!is.null(knitr::current_input())) {
  output_format <- rmarkdown::all_output_formats(knitr::current_input())[1]
  stargazer_type <- ifelse(output_format == "pdf_document", "latex", "text")
} else {
  stargazer_type <- "text"
}

# Function to perform quota simulation
perform_simulation <- function(data, study_type) {
  if (study_type == "gender") {
    feedback_col <- "gender_feedback"
    pick_col <- "female_pick"
    base_col <- "base_gender"
  } else if (study_type == "race") {
    feedback_col <- "race_feedback"
    pick_col <- "race_pick"
    base_col <- "base_race"
  }

  d_original <- data %>%
    mutate(
      condition = ifelse(!!sym(feedback_col) == 1, "Treatment", "Control"),
      pick = !!sym(pick_col),
      base = !!sym(base_col)
    )

  d_quota <- d_original %>%
    filter(condition == "Control") %>%
    mutate(
      pick = case_when(
        base == 0 & pick == 0 ~ 1,
        TRUE ~ pick
      ),
      condition = "Quota"
    )

  d_combined <- bind_rows(d_original, d_quota) %>%
    mutate(
      condition = factor(condition, levels = c("Control", "Quota", "Treatment"))
    )

  lm_model <- lm(pick ~ condition, data = d_combined)
  robust_se <- sqrt(diag(vcovHC(lm_model, type = "HC3")))

  list(model = lm_model, robust_se = robust_se, data = d_original)
}

# Function to extract effects with confidence intervals
extract_effects_with_ci <- function(model, robust_se, study_name, outcome_desc) {
  coefs <- coef(model)
  treatment_effect <- coefs["conditionTreatment"]
  quota_effect <- coefs["conditionQuota"]
  pct_achieved <- (treatment_effect / quota_effect) * 100

  # Get p-values using robust SEs
  t_treat <- treatment_effect / robust_se["conditionTreatment"]
  t_quota <- quota_effect / robust_se["conditionQuota"]
  df <- df.residual(model)
  p_treat <- 2 * pt(-abs(t_treat), df)
  p_quota <- 2 * pt(-abs(t_quota), df)

  # Format with significance stars
  format_pct <- function(val, p) {
    stars <- ifelse(p < 0.001, "***", ifelse(p < 0.01, "**", ifelse(p < 0.05, "*", "")))
    sprintf("%.1f%%%s", val * 100, stars)
  }

  data.frame(
    Study = study_name,
    Outcome = outcome_desc,
    Treatment_Effect = format_pct(treatment_effect, p_treat),
    Quota_Effect = format_pct(quota_effect, p_quota),
    Pct_Achieved = sprintf("%.1f%%", pct_achieved),
    stringsAsFactors = FALSE
  )
}
```

\newpage

## Data Loading

```{r load-data, echo=TRUE}
s2 <- read.csv("Study2.csv", check.names = FALSE)
s3A <- read.csv("Study3A.csv", check.names = FALSE)
s3B <- read.csv("Study3B.csv", check.names = FALSE)
s4A <- read.csv("Study4A.csv", check.names = FALSE)
s4B <- read.csv("Study4B.csv", check.names = FALSE)
```

```{r run-simulations, include=FALSE}
# Define datasets with metadata
datasets <- list(
  s2 = list(data = s2, type = "gender", name = "Study 2",
            outcome = "Biography with Female Protagonist"),
  s3A = list(data = s3A, type = "race", name = "Study 3A",
             outcome = "Film with Racial Minority Protagonist"),
  s3B = list(data = s3B, type = "gender", name = "Study 3B",
             outcome = "Film with Female Protagonist"),
  s4A = list(data = s4A, type = "race", name = "Study 4A",
             outcome = "Book by Racial Minority Author"),
  s4B = list(data = s4B, type = "gender", name = "Study 4B",
             outcome = "Book by Female Author")
)

# Run simulations
results <- map(datasets, ~perform_simulation(.x$data, .x$type))

# Extract models and robust SEs
models <- map(results, "model")
robust_ses <- map(results, "robust_se")
```

\newpage

## Table S12: Summary Comparison of Feedback vs. Quota Effects

This table compares the relative effects of our descriptive feedback intervention with those of a simulated quota condition requiring participants to select at least one woman (Studies 2, 3B, 4B) or one racial minority (Studies 3A, 4A).

```{r table-s12}
# Build Table S12
s12_data <- bind_rows(

  extract_effects_with_ci(models$s2, robust_ses$s2, "Study 2",
                          "Selection of Final Biography with Female Protagonist"),
  extract_effects_with_ci(models$s3A, robust_ses$s3A, "Study 3A",
                          "Selection of Final Film with Racial Minority Protagonist"),
  extract_effects_with_ci(models$s3B, robust_ses$s3B, "Study 3B",
                          "Selection of Final Film with Female Protagonist"),
  extract_effects_with_ci(models$s4A, robust_ses$s4A, "Study 4A",
                          "Selection of Final Book by Racial Minority Author"),
  extract_effects_with_ci(models$s4B, robust_ses$s4B, "Study 4B",
                          "Selection of Final Book by Female Author")
)

kable(s12_data,
      col.names = c("Study", "Outcome of Interest",
                    "Feedback Effect", "Quota Effect",
                    "% of Quota"),
      caption = "Table S12: Comparison of Descriptive Feedback vs. Simulated Quota Effects",
      booktabs = TRUE,
      align = c("l", "l", "r", "r", "r"),
      format = "latex") %>%
  kable_styling(latex_options = c("hold_position", "scale_down"),
                font_size = 9) %>%
  column_spec(2, width = "6cm") %>%
  footnote(general = "* p < .05; ** p < .01; *** p < .001. Effects represent the percentage point increase in likelihood of selecting a woman or racial minority as the final selectee compared to the control condition.",
           general_title = "Note: ",
           footnote_as_chunk = TRUE,
           threeparttable = TRUE)
```

\newpage

## Table S14: Full Regression Results

OLS regressions predicting whether the final selectee was a woman (Studies 2, 3B, 4B) or racial minority (Studies 3A, 4A) as a function of assignment to the simulated quota condition or the descriptive feedback treatment condition (with control as the reference category).

```{r table-s14, results='asis'}
stargazer(models$s2, models$s3A, models$s3B, models$s4A, models$s4B,
          type = stargazer_type,
          title = "Table S14: OLS Regressions Comparing Feedback and Quota Effects",
          column.labels = c("Study 2", "Study 3A", "Study 3B", "Study 4A", "Study 4B"),
          dep.var.labels = c("Final Selection: Woman/Minority"),
          model.numbers = FALSE,
          se = list(robust_ses$s2, robust_ses$s3A, robust_ses$s3B,
                    robust_ses$s4A, robust_ses$s4B),
          keep.stat = c("n", "rsq"),
          notes = c("Robust standard errors in parentheses.",
                    "Studies 2, 3B, 4B: DV = Selected woman. Studies 3A, 4A: DV = Selected racial minority.",
                    "+p<0.1; *p<0.05; **p<0.01; ***p<0.001"),
          notes.append = FALSE,
          header = FALSE,
          covariate.labels = c("Quota Condition", "Feedback Condition", "Constant"),
          omit.stat = c("f", "ser"),
          font.size = "small")
```

