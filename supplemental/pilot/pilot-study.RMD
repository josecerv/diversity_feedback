---
title: "Pilot Study - 2x2 Design (Cond x Base)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    toc: yes
    toc_depth: 2
    fig_caption: true
header-includes:
  \renewcommand{\contentsname}{Items}
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	results = "hide"
)
library(dplyr)
library(lmtest)
library(sandwich)
library(systemfit)
library(car)
library(broom)
library(qualtRics)
library(knitr)
library(rmarkdown)
library(tidyverse)
```

```{r include=FALSE}
qualtrics_api_credentials(api_key = "BJ6aDiEgtQihneCgtZycVLYjaj0ao9gYkdRkb1UZ",
                          base_url = "yul1.qualtrics.com",
                          install = F,
                          overwrite = T)
if ( (!is.null(knitr::current_input()))) {
  if (("pdf_document" ==
                rmarkdown::all_output_formats(knitr::current_input())[1])) {
      stargazer_type <- "latex"
  }
} else {
  stargazer_type <- "text"
}

robust_summary <- function(model) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting original model summary
    model_summary <- summary(model)

    # Updating standard errors, t-values, and p-values in the coefficients table
    model_summary$coefficients[, "Std. Error"] <- robust_se
    model_summary$coefficients[, "t value"] <- model_summary$coefficients[, "Estimate"] / robust_se
    model_summary$coefficients[, "Pr(>|t|)"] <- 2 * pt(-abs(model_summary$coefficients[, "t value"]), df = model_summary$df[2], lower.tail = TRUE)

    return(model_summary)
}
robust_confint <- function(model, level = 0.95) {
    # Calculating robust standard errors
    robust_se <- sqrt(diag(vcovHC(model, type = "HC3")))

    # Getting the coefficients
    est <- coef(model)

    # Calculating the critical value for the t-distribution
    alpha <- 1 - level
    t_crit <- qt(1 - alpha / 2, df = df.residual(model))

    # Calculating the confidence intervals
    lower <- est - t_crit * robust_se
    upper <- est + t_crit * robust_se

    # Combining into a matrix
    confint <- cbind(lower, upper)
    rownames(confint) <- names(est)
    colnames(confint) <- c("2.5 %", "97.5 %")

    return(confint)
}
extract_regression_estimates <- function(model) {
  # Get robust summary
  rob_sum <- robust_summary(model)
  # Get robust confidence intervals
  rob_ci <- robust_confint(model)

  # Extract coefficient for the treatment variable (second row)
  estimate <- rob_sum$coefficients[2, "Estimate"] * 100  # Convert to percentage points
  se <- rob_sum$coefficients[2, "Std. Error"] * 100
  ci_lower <- rob_ci[2, 1] * 100
  ci_upper <- rob_ci[2, 2] * 100

  return(list(
    estimate = estimate,
    se = se,
    ci_lower = ci_lower,
    ci_upper = ci_upper
  ))
}
```

\newpage

## Read Data

```{r echo=TRUE}
# Set this to TRUE if you have API access, FALSE if using CSV
USE_API <- T

if(USE_API) {
  ## Pull directly from Qualtrics API
  qual_data <- fetch_survey(surveyID='SV_dpbDBoF9oHm8TXw',  # Pilot Study ID
                            start_date = "2025-01-01",
                     force_request = T)
} else {
  # Read the processed data directly from CSV
  d0 <- read.csv('pilot-study.csv', check.names = F)
  num_excluded <- unique(d0$num_excluded_total)
}

# Define the categories based on the JavaScript feedback code
# Low base categories (6 authors each)
categories_low <- list(
  women = c('Zadie Smith','J.K. Rowling','Jane Austen',
            'Joyce Carol Oates','Sylvia Plath','Virginia Woolf'),
  poets = c('Charles Dickens','George Orwell','Joyce Carol Oates',
            'Nathaniel Hawthorne','Sylvia Plath','Virginia Woolf'),
  oldies = c('Charles Dickens','Ernest Hemingway','Nathaniel Hawthorne',
             'F. Scott Fitzgerald','Virginia Woolf','Oscar Wilde'),
  books = c('Charles Dickens','J.K. Rowling','John Steinbeck',
            'Joyce Carol Oates','Michael Crichton','Ray Bradbury')
)

# High base categories (12 authors each)
categories_high <- list(
  women = c('Zadie Smith','Lucy Maud','Margaret Atwood','Maya Angelou',
            'Sylvia Plath','Joyce Carol Oates','Virginia Woolf',
            'Isabel Allende','Ayn Rand','Jane Austen','J.K. Rowling','Anya Seton'),
  poets = c('Charles Dickens','Neil Gaiman','George Orwell','Herman Melville',
            'Jorge Luis Borges','Lucy Maud','Margaret Atwood','Maya Angelou',
            'Sylvia Plath','Joyce Carol Oates','Virginia Woolf','Victor Hugo'),
  oldies = c('Charles Dickens','Ernest Hemingway','Herman Melville','Jorge Luis Borges',
             'Lucy Maud','Jack London','Virginia Woolf','Victor Hugo',
             'James Joyce','J.R.R. Tolkien','Oscar Wilde','Rudyard Kipling'),
  books = c('Charles Dickens','Herman Melville','Jorge Luis Borges','Lucy Maud',
            'Jack London','Margaret Atwood','Joyce Carol Oates','Isabel Allende',
            'J.R.R. Tolkien','Rudyard Kipling','J.K. Rowling','Anya Seton')
)

if(USE_API) {
  # Process the API data with new category definitions
  d0 <- qual_data |>
    filter(!is.na(`choice-7`), !is.na(PROLIFIC_PID)) |>
    mutate(
      # Extract base condition from embedded data
      base_condition = tolower(base),

      # Determine which categories to use based on base condition
      categories_to_use = if_else(base_condition == "high", "high", "low"),

      # Gender feedback detection (cond == "treat")
      gender_feedback = as.numeric(cond == "treat"),

      # Attribute feedback detection based on JavaScript code
      poets_shown = as.numeric(grepl("wrote poetry", feedbackItem1) |
                   grepl("wrote poetry", feedbackItem2) |
                   grepl("wrote poetry", feedbackItem3)),

      oldies_shown = as.numeric(grepl("born in the 1800s", feedbackItem1) |
                     grepl("born in the 1800s", feedbackItem2) |
                     grepl("born in the 1800s", feedbackItem3)),

      books_shown = as.numeric(grepl("wrote more than 10 books", feedbackItem1) |
                     grepl("wrote more than 10 books", feedbackItem2) |
                     grepl("wrote more than 10 books", feedbackItem3)),

      women_shown = as.numeric(grepl("were women", feedbackItem1) |
                    grepl("were women", feedbackItem2) |
                    grepl("were women", feedbackItem3))
    )

  # Calculate picks based on the appropriate category list
  for(i in 1:nrow(d0)) {
    if(d0$base_condition[i] == "high") {
      d0$female_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_high$women)
      d0$poets_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_high$poets)
      d0$oldies_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_high$oldies)
      d0$books_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_high$books)

      # Calculate base counts for initial selections
      d0$base_gender[i] <- sum(d0$`choice-1`[i] %in% categories_high$women,
                               d0$`choice-2`[i] %in% categories_high$women,
                               d0$`choice-3`[i] %in% categories_high$women,
                               d0$`choice-4`[i] %in% categories_high$women,
                               d0$`choice-5`[i] %in% categories_high$women,
                               d0$`choice-6`[i] %in% categories_high$women)
      d0$base_poets[i] <- sum(d0$`choice-1`[i] %in% categories_high$poets,
                              d0$`choice-2`[i] %in% categories_high$poets,
                              d0$`choice-3`[i] %in% categories_high$poets,
                              d0$`choice-4`[i] %in% categories_high$poets,
                              d0$`choice-5`[i] %in% categories_high$poets,
                              d0$`choice-6`[i] %in% categories_high$poets)
      d0$base_oldies[i] <- sum(d0$`choice-1`[i] %in% categories_high$oldies,
                               d0$`choice-2`[i] %in% categories_high$oldies,
                               d0$`choice-3`[i] %in% categories_high$oldies,
                               d0$`choice-4`[i] %in% categories_high$oldies,
                               d0$`choice-5`[i] %in% categories_high$oldies,
                               d0$`choice-6`[i] %in% categories_high$oldies)
      d0$base_books[i] <- sum(d0$`choice-1`[i] %in% categories_high$books,
                              d0$`choice-2`[i] %in% categories_high$books,
                              d0$`choice-3`[i] %in% categories_high$books,
                              d0$`choice-4`[i] %in% categories_high$books,
                              d0$`choice-5`[i] %in% categories_high$books,
                              d0$`choice-6`[i] %in% categories_high$books)
    } else {
      d0$female_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_low$women)
      d0$poets_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_low$poets)
      d0$oldies_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_low$oldies)
      d0$books_pick[i] <- as.numeric(d0$`choice-7`[i] %in% categories_low$books)

      # Calculate base counts for initial selections
      d0$base_gender[i] <- sum(d0$`choice-1`[i] %in% categories_low$women,
                               d0$`choice-2`[i] %in% categories_low$women,
                               d0$`choice-3`[i] %in% categories_low$women,
                               d0$`choice-4`[i] %in% categories_low$women,
                               d0$`choice-5`[i] %in% categories_low$women,
                               d0$`choice-6`[i] %in% categories_low$women)
      d0$base_poets[i] <- sum(d0$`choice-1`[i] %in% categories_low$poets,
                              d0$`choice-2`[i] %in% categories_low$poets,
                              d0$`choice-3`[i] %in% categories_low$poets,
                              d0$`choice-4`[i] %in% categories_low$poets,
                              d0$`choice-5`[i] %in% categories_low$poets,
                              d0$`choice-6`[i] %in% categories_low$poets)
      d0$base_oldies[i] <- sum(d0$`choice-1`[i] %in% categories_low$oldies,
                               d0$`choice-2`[i] %in% categories_low$oldies,
                               d0$`choice-3`[i] %in% categories_low$oldies,
                               d0$`choice-4`[i] %in% categories_low$oldies,
                               d0$`choice-5`[i] %in% categories_low$oldies,
                               d0$`choice-6`[i] %in% categories_low$oldies)
      d0$base_books[i] <- sum(d0$`choice-1`[i] %in% categories_low$books,
                              d0$`choice-2`[i] %in% categories_low$books,
                              d0$`choice-3`[i] %in% categories_low$books,
                              d0$`choice-4`[i] %in% categories_low$books,
                              d0$`choice-5`[i] %in% categories_low$books,
                              d0$`choice-6`[i] %in% categories_low$books)
    }
  }

  # Continue processing demographics
  d0 <- d0 |>
    mutate(
      # Demographics
      gender_code = case_when(gender=="Man" ~ 1, TRUE ~ 0),
      race_code = case_when(str_detect(race, "White / Caucasian") ~ 1, TRUE ~ 0)
    ) |>
    dplyr::select(cond, base_condition, gender_feedback, poets_shown, oldies_shown, books_shown, women_shown,
                  female_pick, poets_pick, oldies_pick, books_pick,
                  base_gender, base_poets, base_oldies, base_books, `choice-1`:`choice-7`,
                  race, gender, age, gender_code, race_code)

  # Calculate the number of excluded participants
  num_excluded <- nrow(qual_data) - nrow(d0)

  # Save num_excluded in d0
  d0$num_excluded_total <- num_excluded  # As a column

  # Write the API-pulled data into a CSV file
  write.csv(d0, 'pilot-study.csv', row.names = FALSE, quote = TRUE)
}
```

\newpage

## Variable Names

\begin{table}[!htbp] \centering
  \label{tab:variables}
\begin{tabular}{|l|p{10cm}|}
\hline
\textbf{Variable} & \textbf{Description} \\
\hline
\texttt{cond} & Treatment condition (control or treat). \\
\hline
\texttt{base\_condition} & Base condition (low = 6 authors per category, high = 12 authors per category). \\
\hline
\texttt{gender\_feedback} & Binary indicator of whether participant was in treatment condition (cond = treat). \\
\hline
\texttt{female\_pick} & Binary indicator of whether participant selected a female author for seventh selection. \\
\hline
\texttt{poets\_pick} & Binary indicator of whether participant selected an author who wrote poetry. \\
\hline
\texttt{oldies\_pick} & Binary indicator of whether participant selected an author born in the 1800s. \\
\hline
\texttt{books\_pick} & Binary indicator of whether participant selected an author who wrote 10+ books. \\
\hline
\texttt{base\_gender} & Count of female authors selected in initial six authors. \\
\hline
\texttt{base\_poets} & Count of poets selected in initial six authors. \\
\hline
\texttt{base\_oldies} & Count of 1800s-born authors selected in initial six authors. \\
\hline
\texttt{base\_books} & Count of 10+ book authors selected in initial six authors. \\
\hline
\texttt{choice-1 to choice-7} & The selected authors. \\
\hline
\texttt{gender} & Self-selected gender. \\
\hline
\texttt{race} & Self-selected race. \\
\hline
\texttt{age} & Self-entered age. \\
\hline
\texttt{gender\_code} & Dummy code for gender (male = 1). \\
\hline
\texttt{race\_code} & Dummy code for race (white = 1). \\
\hline
\end{tabular}
\end{table}

\newpage

## Demographics

```{r results='markup'}
## Excluded participants

cat('Excluded Participants:', num_excluded, '\n')

## Gender

gender_percentages <- round(prop.table(table(d0$gender)) * 100, 2)

gender_df <- data.frame(
  Percentage = gender_percentages,
  gender = names(gender_percentages)
)[1:2]

colnames(gender_df) <- c("Percentage", "gender")

print(gender_df)


## Race


race_percentages <- round(prop.table(table(d0$race)) * 100, 2)

# Create the final data frame
race_df <- data.frame(
  Percentage = race_percentages,
  Race = names(race_percentages)
)[1:2]

# Reorder the columns
colnames(race_df) <- c("Percentage", "Race")

# Print the data frame
print(race_df)

## Age

age_summary <- d0 |>
  dplyr::select(age) |>
  summarize(mean_age = mean(age, na.rm = T), sd_age = sd(age, na.rm = T))

age_summary

## Initial Selections Summary

cat('\n--- Initial Selections (Women) ---\n')
cat('Mean (num of initial women selected): ', round(mean(d0$base_gender), 2), '\n')
cat('SD (num of initial women selected): ',round(sd(d0$base_gender), 2), '\n')
cat('Percentage (initial women selected): ', round(mean(d0$base_gender)/6 * 100, 2), '%\n')

cat('\n--- Balance Checks by Condition ---\n')
d0 |>
  dplyr::select(base_gender, gender_feedback) |>
  dplyr::group_by(gender_feedback) |>
  dplyr::summarize(mean_women = mean(base_gender/6))

t.test(base_gender/6 ~ gender_feedback, data=d0)

# Also check balance by base condition
cat('\n--- Balance by Base Condition ---\n')
d0 |>
  dplyr::group_by(base_condition) |>
  dplyr::summarize(
    n = n(),
    mean_women = mean(base_gender/6),
    mean_poets = mean(base_poets/6),
    mean_oldies = mean(base_oldies/6),
    mean_books = mean(base_books/6)
  )

```

\newpage

## Primary Analysis

### Low Base Condition (6 authors per category)

```{r echo=TRUE, results='markup'}
# Create condition-specific datasets
d0_low <- d0 |> filter(base_condition == "low")
d0_high <- d0 |> filter(base_condition == "high")

# Effect of gender feedback in low base condition
r_low <- lm(female_pick ~ gender_feedback, data=d0_low)

cat("Effect in Low Base Condition (6 authors per category):\n")
robust_summary(r_low)
robust_confint(r_low)
```

\newpage

### High Base Condition (12 authors per category)

```{r echo=TRUE, results='markup'}
# Effect of gender feedback in high base condition
r_high <- lm(female_pick ~ gender_feedback, data=d0_high)

cat("Effect in High Base Condition (12 authors per category):\n")
robust_summary(r_high)
robust_confint(r_high)
```

\newpage

### Interaction Model

```{r echo=TRUE, results='markup'}
# Full 2x2 factorial model testing interaction
r_factorial <- lm(female_pick ~ gender_feedback * base_condition, data=d0)

cat("2x2 Factorial Design: Gender Feedback x Base Condition\n")
robust_summary(r_factorial)
robust_confint(r_factorial)

```

\newpage

### Testing Asymmetry in Effects

```{r echo=TRUE, results='markup'}
# Test whether the effect of gender feedback differs significantly
# between low and high base conditions

# The interaction coefficient tests this directly
interaction_coef <- coef(r_factorial)['gender_feedback:base_conditionlow']
interaction_se <- sqrt(diag(vcovHC(r_factorial, type = "HC3")))['gender_feedback:base_conditionlow']
interaction_t <- interaction_coef / interaction_se
interaction_p <- 2 * pt(-abs(interaction_t), df = df.residual(r_factorial))

cat('\nTest of Asymmetry (Interaction Term):\n')
cat('Difference in effects:', round(interaction_coef * 100, 2), 'percentage points\n')
cat('Robust standard error:', round(interaction_se * 100, 2), '\n')
cat('p-value:', round(interaction_p, 4), '\n\n')

if(interaction_p < 0.05) {
  cat('The asymmetry IS statistically significant (p < 0.05).\n')
  cat('The effect of gender feedback differs significantly between base conditions.\n')
} else {
  cat('The asymmetry is NOT statistically significant (p >= 0.05).\n')
}
```

\newpage

### Visualization of 2x2 Design

```{r echo=TRUE}
library(ggplot2)

interaction_means <- d0 |>
  group_by(gender_feedback, base_condition) |>
  summarize(
    mean_female = mean(female_pick, na.rm = TRUE),
    se_female = sd(female_pick, na.rm = TRUE) / sqrt(n()),
    n = n()
  )

p_2x2 <- ggplot(interaction_means, aes(x = factor(base_condition), y = mean_female * 100,
                                       fill = factor(gender_feedback))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  geom_errorbar(aes(ymin = (mean_female - 1.96*se_female) * 100,
                    ymax = (mean_female + 1.96*se_female) * 100),
                width = 0.2, position = position_dodge(width = 0.8)) +
  scale_fill_manual(values = c("0" = "#990000", "1" = "#011F5B"),
                    labels = c("0" = "Control", "1" = "Gender Feedback")) +
  labs(x = "Base Condition (Category Size)",
       y = "% Selecting Female Author",
       title = "2x2 Factorial: Gender Feedback x Base Condition",
       fill = "Treatment") +
  scale_x_discrete(labels = c("low" = "Low\n(6 authors)", "high" = "High\n(12 authors)")) +
  theme_bw() +
  theme(legend.position = "top")

print(p_2x2)
```

\newpage

## Robustness Checks

### Low Base Condition

```{r echo=TRUE, results='markup'}
## Robust to demographic controls
r_low_demog <- lm(female_pick ~ gender_feedback + gender_code + race_code + age, data=d0_low)

cat("Low Base: With Demographic Controls\n")
robust_summary(r_low_demog)
robust_confint(r_low_demog)

## Logistic regression
r_low_logit <- glm(female_pick ~ gender_feedback, family = binomial, data=d0_low)
cat("\nLow Base: Logistic Regression Model\n")
summary(r_low_logit)
# Odds ratio
tidy_low_logit <- tidy(r_low_logit, exponentiate = TRUE, conf.int = T)
print(tidy_low_logit)
```

\newpage

### High Base Condition

```{r echo=TRUE, results='markup'}
## Robust to demographic controls
r_high_demog <- lm(female_pick ~ gender_feedback + gender_code + race_code + age, data=d0_high)

cat("High Base: With Demographic Controls\n")
robust_summary(r_high_demog)
robust_confint(r_high_demog)

## Logistic regression
r_high_logit <- glm(female_pick ~ gender_feedback, family = binomial, data=d0_high)
cat("\nHigh Base: Logistic Regression Model\n")
summary(r_high_logit)
# Odds ratio
tidy_high_logit <- tidy(r_high_logit, exponentiate = TRUE, conf.int = T)
print(tidy_high_logit)
```

\newpage

### Interaction Model with Controls

```{r echo=TRUE, results='markup'}
## Interaction model with demographic controls
r_factorial_demog <- lm(female_pick ~ gender_feedback*base_condition + gender_code + race_code + age, data=d0)

cat("2x2 Factorial with Demographic Controls\n")
robust_summary(r_factorial_demog)
robust_confint(r_factorial_demog)

## Logistic regression with interaction
r_factorial_logit <- glm(female_pick ~ gender_feedback*base_condition, family = binomial, data=d0)
cat("\n2x2 Factorial: Logistic Regression Model\n")
summary(r_factorial_logit)
# Odds ratio
tidy_factorial_logit <- tidy(r_factorial_logit, exponentiate = TRUE, conf.int = T)
print(tidy_factorial_logit)
```

\newpage

## Interaction with Initial Base Selection

### Low Base Condition

```{r echo=TRUE, results='markup'}
## Interaction with initial women selection in low base
r_interaction_low <- lm(female_pick ~ gender_feedback*base_gender, data=d0_low)

cat("Low Base: Interaction with Initial Women Selection\n")
robust_summary(r_interaction_low)
robust_confint(r_interaction_low)
```

\newpage

### High Base Condition

```{r echo=TRUE, results='markup'}
## Interaction with initial women selection in high base
r_interaction_high <- lm(female_pick ~ gender_feedback*base_gender, data=d0_high)

cat("High Base: Interaction with Initial Women Selection\n")
robust_summary(r_interaction_high)
robust_confint(r_interaction_high)
```

\newpage

### Full Model with Three-Way Interaction

```{r echo=TRUE, results='markup'}
## Three-way interaction: gender_feedback x base_condition x base_gender
r_interaction_full <- lm(female_pick ~ gender_feedback*base_condition*base_gender, data=d0)

cat("Three-Way Interaction: Gender Feedback x Base Condition x Initial Women Selection\n")
robust_summary(r_interaction_full)
robust_confint(r_interaction_full)
```

\newpage

## Secondary Analysis - Other Attributes

### Low Base Condition

```{r echo=TRUE, results='markup'}
## Poets feedback - Low Base
r_poets_low <- lm(poets_pick ~ poets_shown, data=d0_low)
cat("Low Base: Effect of Poets Feedback on Poet Selection\n")
robust_summary(r_poets_low)
robust_confint(r_poets_low)

## Oldies (1800s) feedback - Low Base
r_oldies_low <- lm(oldies_pick ~ oldies_shown, data=d0_low)
cat("\nLow Base: Effect of 1800s Feedback on 1800s Author Selection\n")
robust_summary(r_oldies_low)
robust_confint(r_oldies_low)

## Books (10+) feedback - Low Base
r_books_low <- lm(books_pick ~ books_shown, data=d0_low)
cat("\nLow Base: Effect of 10+ Books Feedback on 10+ Books Author Selection\n")
robust_summary(r_books_low)
robust_confint(r_books_low)
```

\newpage

### High Base Condition

```{r echo=TRUE, results='markup'}
## Poets feedback - High Base
r_poets_high <- lm(poets_pick ~ poets_shown, data=d0_high)
cat("High Base: Effect of Poets Feedback on Poet Selection\n")
robust_summary(r_poets_high)
robust_confint(r_poets_high)

## Oldies (1800s) feedback - High Base
r_oldies_high <- lm(oldies_pick ~ oldies_shown, data=d0_high)
cat("\nHigh Base: Effect of 1800s Feedback on 1800s Author Selection\n")
robust_summary(r_oldies_high)
robust_confint(r_oldies_high)

## Books (10+) feedback - High Base
r_books_high <- lm(books_pick ~ books_shown, data=d0_high)
cat("\nHigh Base: Effect of 10+ Books Feedback on 10+ Books Author Selection\n")
robust_summary(r_books_high)
robust_confint(r_books_high)
```

\newpage

### Interaction Models for Other Attributes

```{r echo=TRUE, results='markup'}
## Test if attribute feedback effects differ by base condition
r_poets_interaction <- lm(poets_pick ~ poets_shown*base_condition, data=d0)
cat("Poets x Base Condition Interaction\n")
robust_summary(r_poets_interaction)
robust_confint(r_poets_interaction)

r_oldies_interaction <- lm(oldies_pick ~ oldies_shown*base_condition, data=d0)
cat("\nOldies x Base Condition Interaction\n")
robust_summary(r_oldies_interaction)
robust_confint(r_oldies_interaction)

r_books_interaction <- lm(books_pick ~ books_shown*base_condition, data=d0)
cat("\nBooks x Base Condition Interaction\n")
robust_summary(r_books_interaction)
robust_confint(r_books_interaction)
```

```{r include=FALSE}
# Extract estimates for simple effects within each base condition
# For low base condition
gender_est_low <- extract_regression_estimates(r_low)
poets_est_low <- extract_regression_estimates(r_poets_low)
oldies_est_low <- extract_regression_estimates(r_oldies_low)
books_est_low <- extract_regression_estimates(r_books_low)

# For high base condition
gender_est_high <- extract_regression_estimates(r_high)
poets_est_high <- extract_regression_estimates(r_poets_high)
oldies_est_high <- extract_regression_estimates(r_oldies_high)
books_est_high <- extract_regression_estimates(r_books_high)

# Create separate data frames for each condition
pilot_estimates_low <- data.frame(
    Study = "PILOT_LOW",
    Base_Condition = "Low (6 authors)",
    Stimuli = c("gender", "poets", "oldies", "books"),
    Estimate = c(gender_est_low$estimate, poets_est_low$estimate, oldies_est_low$estimate, books_est_low$estimate),
    SE = c(gender_est_low$se, poets_est_low$se, oldies_est_low$se, books_est_low$se),
    CI_Lower = c(gender_est_low$ci_lower, poets_est_low$ci_lower, oldies_est_low$ci_lower, books_est_low$ci_lower),
    CI_Upper = c(gender_est_low$ci_upper, poets_est_low$ci_upper, oldies_est_low$ci_upper, books_est_low$ci_upper)
)

pilot_estimates_high <- data.frame(
    Study = "PILOT_HIGH",
    Base_Condition = "High (12 authors)",
    Stimuli = c("gender", "poets", "oldies", "books"),
    Estimate = c(gender_est_high$estimate, poets_est_high$estimate, oldies_est_high$estimate, books_est_high$estimate),
    SE = c(gender_est_high$se, poets_est_high$se, oldies_est_high$se, books_est_high$se),
    CI_Lower = c(gender_est_high$ci_lower, poets_est_high$ci_lower, oldies_est_high$ci_lower, books_est_high$ci_lower),
    CI_Upper = c(gender_est_high$ci_upper, poets_est_high$ci_upper, oldies_est_high$ci_upper, books_est_high$ci_upper)
)

# Combine both
pilot_estimates <- rbind(pilot_estimates_low, pilot_estimates_high)

# Save the estimates to an RDS file
saveRDS(pilot_estimates, file = "pilot_estimates.rds")

```


## Figure - Simple Effects by Base Condition

### Low Base Condition Figure

```{r echo=TRUE}

# Get p-values from regression models for LOW base condition
p_gender_low <- robust_summary(r_low)$coefficients["gender_feedback", "Pr(>|t|)"]
p_poets_low <- robust_summary(r_poets_low)$coefficients["poets_shown", "Pr(>|t|)"]
p_oldies_low <- robust_summary(r_oldies_low)$coefficients["oldies_shown", "Pr(>|t|)"]
p_books_low <- robust_summary(r_books_low)$coefficients["books_shown", "Pr(>|t|)"]

# Function to convert p-value to significance stars
get_sig_stars <- function(p) {
  if (p < 0.001) return("***")
  else if (p < 0.01) return("**")
  else if (p < 0.05) return("*")
  else return("n.s.")
}

# Get significance labels for LOW base
sig_gender_low <- get_sig_stars(p_gender_low)
sig_poets_low <- get_sig_stars(p_poets_low)
sig_oldies_low <- get_sig_stars(p_oldies_low)
sig_books_low <- get_sig_stars(p_books_low)

dfemale_plot_low <- d0_low |>
  dplyr::select(gender_feedback, female_pick) |>
  dplyr::group_by(gender_feedback) |>
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) |>
  dplyr::mutate(
    gender_feedback = case_when(
      gender_feedback == 1 ~ "\"Treatment\"",
      TRUE ~ "\"Control\""
    )
  ) |>
  dplyr::rename(Condition = gender_feedback)

dpoets_plot_low <- d0_low |>
  dplyr::select(poets_shown, poets_pick) |>
  dplyr::group_by(poets_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(poets_pick),
    sd = sd(poets_pick) * 100,
    se = (sd(poets_pick) / sqrt(n())) * 100
  )|>
  mutate(poets_shown = case_when(poets_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = poets_shown)

doldies_plot_low <- d0_low |>
  dplyr::select(oldies_shown, oldies_pick) |>
  dplyr::group_by(oldies_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(oldies_pick),
    sd = sd(oldies_pick) * 100,
    se = (sd(oldies_pick) / sqrt(n())) * 100
  )|>
  mutate(oldies_shown = case_when(oldies_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = oldies_shown)

dbooks_plot_low <- d0_low |>
  dplyr::select(books_shown, books_pick) |>
  dplyr::group_by(books_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(books_pick),
    sd = sd(books_pick) * 100,
    se = (sd(books_pick) / sqrt(n())) * 100
  )|>
  mutate(books_shown = case_when(books_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = books_shown)

## Combine plots for LOW base
df_combined_low <- bind_rows(
  dpoets_plot_low %>% mutate(Category = "\nWrote Poetry", sig_label = sig_poets_low),
  doldies_plot_low %>% mutate(Category = "\nBorn in 1800s", sig_label = sig_oldies_low),
  dbooks_plot_low %>% mutate(Category = "\n10+ Books\nWritten", sig_label = sig_books_low),
  dfemale_plot_low %>% mutate(Category = "\nWere Women", sig_label = sig_gender_low)
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('\nWrote Poetry', '\nBorn in 1800s', '\n10+ Books\nWritten', '\nWere Women')))

p_combined_low <- ggplot(df_combined_low, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 5, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~factor(Category, c('\nWrote Poetry', '\nBorn in 1800s', '\n10+ Books\nWritten', '\nWere Women')), nrow = 1, strip.position = "bottom") +
   geom_segment(data = df_combined_low %>% filter(Condition == "\"Treatment\""),
                aes(x = 1, xend = 2, y = freq*100 + se + 5, yend = freq*100 + se + 5),
                inherit.aes = FALSE) +
   geom_text(data = df_combined_low %>% filter(Condition == "\"Treatment\""),
             aes(x = 1.5, y = freq*100 + se + 7, label = sig_label),
             inherit.aes = FALSE, vjust = 0, size = 5) +
  theme_bw() +
  scale_fill_manual(values = c("#990000", "#011F5B"), labels = c("No feedback provided", "Feedback provided"), "Feedback") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("\"Control\"" = "Not\nShown", "\"Treatment\"" = "Shown")) +
  labs(x = "Feedback on % of authors who...", y = "% of New Authors with the Target Attribute",
       title = "Low Base Condition (6 authors per category)") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        legend.text = element_text(size = 20),
        legend.key.size = unit(7, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(face="bold", size = 21, vjust = 17),
        plot.title = element_text(size = 18, hjust = 0.5),
        axis.title.y = element_text(size = 20, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 20, color = "black"),
        strip.text = element_text(size = 20, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

print(p_combined_low)
ggsave("Figure-Pilot-Low.pdf", plot = p_combined_low, width = 10, height = 8, units = "in", device = cairo_pdf, family = "Times New Roman")
```

\newpage

### High Base Condition Figure

```{r echo=TRUE}
# Get p-values from regression models for HIGH base condition
p_gender_high <- robust_summary(r_high)$coefficients["gender_feedback", "Pr(>|t|)"]
p_poets_high <- robust_summary(r_poets_high)$coefficients["poets_shown", "Pr(>|t|)"]
p_oldies_high <- robust_summary(r_oldies_high)$coefficients["oldies_shown", "Pr(>|t|)"]
p_books_high <- robust_summary(r_books_high)$coefficients["books_shown", "Pr(>|t|)"]

# Get significance labels for HIGH base
sig_gender_high <- get_sig_stars(p_gender_high)
sig_poets_high <- get_sig_stars(p_poets_high)
sig_oldies_high <- get_sig_stars(p_oldies_high)
sig_books_high <- get_sig_stars(p_books_high)

dfemale_plot_high <- d0_high |>
  dplyr::select(gender_feedback, female_pick) |>
  dplyr::group_by(gender_feedback) |>
  dplyr::summarise(
    n = n(),
    freq = mean(female_pick),
    sd = sd(female_pick) * 100,
    se = (sd(female_pick) / sqrt(n())) * 100
  ) |>
  dplyr::mutate(
    gender_feedback = case_when(
      gender_feedback == 1 ~ "\"Treatment\"",
      TRUE ~ "\"Control\""
    )
  ) |>
  dplyr::rename(Condition = gender_feedback)

dpoets_plot_high <- d0_high |>
  dplyr::select(poets_shown, poets_pick) |>
  dplyr::group_by(poets_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(poets_pick),
    sd = sd(poets_pick) * 100,
    se = (sd(poets_pick) / sqrt(n())) * 100
  )|>
  mutate(poets_shown = case_when(poets_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = poets_shown)

doldies_plot_high <- d0_high |>
  dplyr::select(oldies_shown, oldies_pick) |>
  dplyr::group_by(oldies_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(oldies_pick),
    sd = sd(oldies_pick) * 100,
    se = (sd(oldies_pick) / sqrt(n())) * 100
  )|>
  mutate(oldies_shown = case_when(oldies_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = oldies_shown)

dbooks_plot_high <- d0_high |>
  dplyr::select(books_shown, books_pick) |>
  dplyr::group_by(books_shown) |>
  dplyr::summarise(
    n = n(),
    freq = mean(books_pick),
    sd = sd(books_pick) * 100,
    se = (sd(books_pick) / sqrt(n())) * 100
  )|>
  mutate(books_shown = case_when(books_shown==1 ~ "\"Treatment\"",
                          TRUE ~ "\"Control\"")) |>
  rename(Condition = books_shown)

## Combine plots for HIGH base
df_combined_high <- bind_rows(
  dpoets_plot_high %>% mutate(Category = "\nWrote Poetry", sig_label = sig_poets_high),
  doldies_plot_high %>% mutate(Category = "\nBorn in 1800s", sig_label = sig_oldies_high),
  dbooks_plot_high %>% mutate(Category = "\n10+ Books\nWritten", sig_label = sig_books_high),
  dfemale_plot_high %>% mutate(Category = "\nWere Women", sig_label = sig_gender_high)
, .id = "id") %>%
  mutate(Category = factor(Category, levels = c('\nWrote Poetry', '\nBorn in 1800s', '\n10+ Books\nWritten', '\nWere Women')))

p_combined_high <- ggplot(df_combined_high, aes(x = Condition, y = freq*100, fill = Condition)) +
  geom_bar(stat="identity", width = 0.85, position = position_dodge(width = 0.7)) +
  geom_text(aes(label=paste0(sprintf("%.1f", freq*100),"%")),
            position=position_dodge(width=0.7), vjust=5, size = 5, color = "white") +
  geom_errorbar(aes(ymin=freq*100-se, ymax=freq*100+se), width = .1, position = position_dodge(width = 0.7)) +
  facet_wrap(~factor(Category, c('\nWrote Poetry', '\nBorn in 1800s', '\n10+ Books\nWritten', '\nWere Women')), nrow = 1, strip.position = "bottom") +
   geom_segment(data = df_combined_high %>% filter(Condition == "\"Treatment\""),
                aes(x = 1, xend = 2, y = freq*100 + se + 5, yend = freq*100 + se + 5),
                inherit.aes = FALSE) +
   geom_text(data = df_combined_high %>% filter(Condition == "\"Treatment\""),
             aes(x = 1.5, y = freq*100 + se + 7, label = sig_label),
             inherit.aes = FALSE, vjust = 0, size = 5) +
  theme_bw() +
  scale_fill_manual(values = c("#990000", "#011F5B"), labels = c("No feedback provided", "Feedback provided"), "Feedback") +
  scale_y_continuous(labels = function(x) paste0(x,"%"), limits = c(0,100)) +
  scale_x_discrete(labels = c("\"Control\"" = "Not\nShown", "\"Treatment\"" = "Shown")) +
  labs(x = "Feedback on % of authors who...", y = "% of New Authors with the Target Attribute",
       title = "High Base Condition (12 authors per category)") +
  theme(plot.caption = element_text(face = "italic"),
        legend.position = c(0.5, 0.95),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        legend.text = element_text(size = 20),
        legend.key.size = unit(7, 'mm'),
        legend.background = element_rect(fill = "white"),
        panel.grid.minor = element_blank(),
        panel.grid = element_blank(),
        panel.border = element_rect(fill= NA, color = "white"),
        plot.background = element_rect(fill = "white"),
        panel.background = element_rect(fill = "white"),
        axis.title.x = element_text(face="bold", size = 21, vjust = 17),
        plot.title = element_text(size = 18, hjust = 0.5),
        axis.title.y = element_text(size = 20, color = "black"),
        axis.text.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_text(size = 20, color = "black"),
        strip.text = element_text(size = 20, color = "black"),
        strip.background = element_rect(colour = "white", fill = "white"))

print(p_combined_high)
ggsave("Figure-Pilot-High.pdf", plot = p_combined_high, width = 10, height = 8, units = "in", device = cairo_pdf, family = "Times New Roman")
```


## System of Simultaneous Equations

### Low Base Condition

```{r results='markup'}
cat("LOW BASE CONDITION: Testing equality of attribute feedback effects\n\n")

# Poets - Low Base
poets.eqn_low <- list(
  poetseq = as.numeric(poets_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
restrict_poets <- "poetseq_poets_shown - femaleeq_gender_feedback = 0"
unrestricted_poets_low <- systemfit(poets.eqn_low, data=d0_low)

# Oldies - Low Base
oldies.eqn_low <- list(
  oldieseq = as.numeric(oldies_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
restrict_oldies <- "oldieseq_oldies_shown - femaleeq_gender_feedback = 0"
unrestricted_oldies_low <- systemfit(oldies.eqn_low, data=d0_low)

# Books - Low Base
books.eqn_low <- list(
  bookseq = as.numeric(books_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
restrict_books <- "bookseq_books_shown - femaleeq_gender_feedback = 0"
unrestricted_books_low <- systemfit(books.eqn_low, data=d0_low)

# Wald tests - Low Base
lh_result_poets_low = linearHypothesis(unrestricted_poets_low, restrict_poets)
lh_result_oldies_low = linearHypothesis(unrestricted_oldies_low, restrict_oldies)
lh_result_books_low = linearHypothesis(unrestricted_books_low, restrict_books)

# Collecting results - Low Base
poets_coef_low <- lh_result_poets_low$F[2]
oldies_coef_low <- lh_result_oldies_low$F[2]
books_coef_low <- lh_result_books_low$F[2]

p_value_poets_low = lh_result_poets_low$`Pr(>F)`[2]
p_value_oldies_low = lh_result_oldies_low$`Pr(>F)`[2]
p_value_books_low = lh_result_books_low$`Pr(>F)`[2]

# Summary table - Low Base
data.frame(
  `Test` = c("Gender Feedback - Poets Feedback", "Gender Feedback - Oldies Feedback", "Gender Feedback - Books Feedback"),
  `Wald Coefficient` = c(poets_coef_low, oldies_coef_low, books_coef_low),
  P_Value = c(p_value_poets_low, p_value_oldies_low, p_value_books_low),
  row.names = 1
)
```

\newpage

### High Base Condition

```{r results='markup'}
cat("HIGH BASE CONDITION: Testing equality of attribute feedback effects\n\n")

# Poets - High Base
poets.eqn_high <- list(
  poetseq = as.numeric(poets_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
unrestricted_poets_high <- systemfit(poets.eqn_high, data=d0_high)

# Oldies - High Base
oldies.eqn_high <- list(
  oldieseq = as.numeric(oldies_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
unrestricted_oldies_high <- systemfit(oldies.eqn_high, data=d0_high)

# Books - High Base
books.eqn_high <- list(
  bookseq = as.numeric(books_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1,
  femaleeq = as.numeric(female_pick) ~ poets_shown + oldies_shown + books_shown + gender_feedback - 1
)
unrestricted_books_high <- systemfit(books.eqn_high, data=d0_high)

# Wald tests - High Base
lh_result_poets_high = linearHypothesis(unrestricted_poets_high, restrict_poets)
lh_result_oldies_high = linearHypothesis(unrestricted_oldies_high, restrict_oldies)
lh_result_books_high = linearHypothesis(unrestricted_books_high, restrict_books)

# Collecting results - High Base
poets_coef_high <- lh_result_poets_high$F[2]
oldies_coef_high <- lh_result_oldies_high$F[2]
books_coef_high <- lh_result_books_high$F[2]

p_value_poets_high = lh_result_poets_high$`Pr(>F)`[2]
p_value_oldies_high = lh_result_oldies_high$`Pr(>F)`[2]
p_value_books_high = lh_result_books_high$`Pr(>F)`[2]

# Summary table - High Base
data.frame(
  `Test` = c("Gender Feedback - Poets Feedback", "Gender Feedback - Oldies Feedback", "Gender Feedback - Books Feedback"),
  `Wald Coefficient` = c(poets_coef_high, oldies_coef_high, books_coef_high),
  P_Value = c(p_value_poets_high, p_value_oldies_high, p_value_books_high),
  row.names = 1
)
```